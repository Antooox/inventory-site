<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Inventory</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6f7f9; padding:30px}
    .card{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;padding:22px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{margin:0 0 12px}
    .row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    input[type="text"], input[type="date"]{padding:10px 12px;border-radius:8px;border:1px solid #e0e3e8;flex:1}
    button{background:#0ea5a4;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .amount-controls{display:flex;gap:6px;align-items:center}
    .minus, .plus{width:32px;height:28px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .danger{background:#ef4444}
    .muted{color:#657084;font-size:13px}
    .small{font-size:13px;padding:7px 10px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Shared inventory</h1>
    <p class="muted">Add items here â€” everyone who opens this page will see the same list.</p>

    <div class="row">
      <input id="objectInput" type="text" placeholder="Ex: Valve ABC-123" />
      <input id="dateInput" type="date" />
      <input id="amountInput" type="number" min="1" value="1" style="width:80px" />
      <button id="addBtn">Add to list</button>
    </div>

    <table id="itemsTable">
      <thead>
        <tr><th></th><th>Object</th><th>Amount</th><th>Added date</th><th>Added at</th></tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" class="muted">No items yet</td></tr>
      </tbody>
    </table>

    <div style="margin-top:14px;display:flex;gap:8px">
      <button id="removeBtn" class="small danger">Remove selected</button>
      <button id="undoBtn" class="small">Undo remove</button>
      <button id="exportBtn" class="small">Export CSV</button>
      <span id="status" class="muted" style="margin-left:auto"></span>
    </div>
  </div>

<script>
/* ========== CONFIG - replace with your values ========== */
const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co'; // <-- replace
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY'; // <-- replace
const ROW_KEY = 'row1_logistics'; // shared key for this page
/* ====================================================== */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let listRowId = null;   // uuid of the row in DB
let items = [];         // local copy of items array
let lastRemoved = null; // for undo

const $object = document.getElementById('objectInput');
const $date = document.getElementById('dateInput');
const $amount = document.getElementById('amountInput');
const $add = document.getElementById('addBtn');
const $tbody = document.getElementById('tbody');
const $remove = document.getElementById('removeBtn');
const $undo = document.getElementById('undoBtn');
const $export = document.getElementById('exportBtn');
const $status = document.getElementById('status');

window.addEventListener('load', init);

async function init(){
  $date.value = new Date().toISOString().slice(0,10);
  $add.onclick = onAdd;
  $remove.onclick = onRemoveSelected;
  $undo.onclick = onUndo;
  $export.onclick = onExportCSV;
  await loadOrCreateListRow();
  render();
}

async function loadOrCreateListRow(){
  setStatus('Loading...');
  // 1) try to read existing row by ROW_KEY
  const { data, error } = await supabase.from('lists').select('*').eq('row', ROW_KEY).limit(1).maybeSingle();
  if (error){
    console.error('select error', error);
    setStatus('Failed to load');
    return;
  }
  if (data){
    listRowId = data.id;
    items = data.items || [];
    setStatus('Loaded');
    return;
  }
  // 2) create row if not exists
  const toInsert = { row: ROW_KEY, items: [] };
  const { data: ins, error: insErr } = await supabase.from('lists').insert([toInsert]).select().maybeSingle();
  if (insErr){
    console.error('insert error', insErr);
    setStatus('Failed to create');
    return;
  }
  listRowId = ins.id;
  items = ins.items || [];
  setStatus('Created shared list');
}

function makeRowHtml(item, idx){
  const checked = item._checked ? 'checked' : '';
  return `
    <tr data-idx="${idx}">
      <td><input type="checkbox" class="sel" ${checked}></td>
      <td>${escapeHtml(item.object)}</td>
      <td>
        <div class="amount-controls">
          <button class="minus" data-action="dec">-</button>
          <span class="muted">${item.amount}</span>
          <button class="plus" data-action="inc">+</button>
        </div>
      </td>
      <td>${item.addedDate || ''}</td>
      <td>${item.addedAt || ''}</td>
    </tr>
  `;
}

function render(){
  if (!items || items.length === 0){
    $tbody.innerHTML = `<tr><td colspan="5" class="muted">No items yet</td></tr>`;
    return;
  }
  $tbody.innerHTML = items.map((it, i) => makeRowHtml(it,i)).join('');
  // attach handlers for amount +/- and checkbox change
  document.querySelectorAll('#tbody .minus, #tbody .plus').forEach(btn=>{
    btn.onclick = (e)=>{
      const tr = e.target.closest('tr');
      const idx = Number(tr.dataset.idx);
      if (e.target.dataset.action === 'inc') items[idx].amount = Number(items[idx].amount || 0) + 1;
      else items[idx].amount = Math.max(1, Number(items[idx].amount || 1) - 1);
      saveItemsDebounced();
      render();
    };
  });
  document.querySelectorAll('#tbody .sel').forEach(ch=>{
    ch.onchange = (e)=>{
      const idx = Number(e.target.closest('tr').dataset.idx);
      items[idx]._checked = e.target.checked;
    };
  });
}

async function onAdd(){
  const object = $object.value.trim();
  const addedDate = $date.value || new Date().toISOString().slice(0,10);
  const amount = Math.max(1, Number($amount.value || 1));
  if (!object) return alert('Please enter an object name');
  const newItem = {
    id: generateId(),
    object,
    amount,
    addedDate,
    addedAt: new Date().toISOString()
  };
  items.push(newItem);
  $object.value = '';
  $amount.value = 1;
  render();
  await saveItems(); // immediate save
}

async function onRemoveSelected(){
  const selected = items.filter(i => i._checked);
  if (!selected.length) return alert('Select at least one row');
  lastRemoved = selected;
  items = items.filter(i => !i._checked);
  await saveItems();
  render();
}

async function onUndo(){
  if (!lastRemoved) return;
  items = items.concat(lastRemoved);
  lastRemoved = null;
  await saveItems();
  render();
}

function onExportCSV(){
  const rows = items.map(i => [i.object, i.amount, i.addedDate, i.addedAt]);
  const csv = [['object','amount','addedDate','addedAt'], ...rows].map(r => r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ============= persistence ============= */

let saveTimer = null;
function saveItemsDebounced(){
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> saveItems(), 400);
}

async function saveItems(){
  if (!listRowId){
    // fallback: try to create row and retry
    await loadOrCreateListRow();
    if (!listRowId){ setStatus('Cannot create row'); return; }
  }
  setStatus('Saving...');
  const payload = { items };
  const { data, error } = await supabase.from('lists').update(payload).eq('id', listRowId).select().maybeSingle();
  if (error){
    console.error('save error', error);
    setStatus('Save failed');
    return;
  }
  // success
  items = data.items || [];
  setStatus('Saved');
}

/* ============= helpers ============= */

function generateId(){ return 'id-' + Math.random().toString(36).slice(2,10); }

function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function setStatus(t){ $status.textContent = t || ''; }
</script>
</body>
</html>
