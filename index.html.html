<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shared inventory</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net"/>
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7b7a;
      --primary:#0f8f83; --primary-weak:#e8f2f1;
      --danger:#b02a2a; --danger-weak:#f6e8e8;
      --border:#e6eeec; --text:#0f1f1e;
      --radius:14px;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px 22px}
    h1{margin:0 0 6px 0;font-size:38px;font-weight:800;letter-spacing:.2px}
    p.sub{margin:0 0 22px 0;color:var(--muted)}
    label{display:block;font-weight:700;margin:14px 0 6px}
    input[type="text"],input[type="date"],input[type="number"],select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-3{display:grid;grid-template-columns:1.2fr .8fr .8fr;gap:14px}
    .actions-top{display:flex;justify-content:flex-end;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--primary-weak);color:var(--primary)}
    .btn.danger{background:var(--danger-weak);color:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px}
    thead th{text-align:left;font-size:14px;color:var(--muted);border-bottom:1px solid var(--border);padding:10px 10px}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}
    .qty-input{width:70px}
    .actions-row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .status{color:var(--muted);font-size:13px;margin-top:10px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Shared inventory</h1>
      <p class="sub">Everyone who opens this page sees the same list. Changes autosave automatically.</p>

      <div class="row">
        <div>
          <label for="rowSelect">Select row</label>
          <select id="rowSelect" aria-label="Row"></select>
        </div>
      </div>

      <div class="row-3" style="margin-top:10px">
        <div>
          <label for="itemObject">Object</label>
          <input id="itemObject" type="text" placeholder="Object â€” e.g. Valve ABC-123"/>
        </div>
        <div>
          <label for="itemDate">Added date</label>
          <input id="itemDate" type="date"/>
        </div>
        <div>
          <label for="itemAmount">Amount</label>
          <input id="itemAmount" class="qty-input" type="number" min="1" step="1" value="1"/>
        </div>
      </div>

      <div class="actions-top">
        <button id="addBtn" class="btn primary" title="Add to list">
          <!-- plus icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          Add to list
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40px;"><input type="checkbox" id="checkAll"/></th>
            <th>Object</th>
            <th style="width:110px;">Amount</th>
            <th style="width:160px;">Added date</th>
            <th style="width:220px;">Added at</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>

      <div class="actions-row">
        <button id="removeSelectedBtn" class="btn danger" title="Remove selected">
          <!-- minus icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          Remove selected
        </button>

        <div class="right">
          <button id="exportCsvBtn" class="btn secondary" title="Export CSV">
            <!-- export icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 3v10m0 0l-3-3m3 3l3-3M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Export CSV
          </button>
        </div>
      </div>

      <div id="status" class="status">Status: ready</div>
    </div>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase config (din) ===
    const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === State ===
    const rowsList = Array.from({length:20},(_,i)=>`ROW${i+1}`);
    let currentItems = []; // {id,row,object,amount,added_date,added_at}

    // === UI refs ===
    const rowSelect      = document.getElementById('rowSelect');
    const itemObject     = document.getElementById('itemObject');
    const itemAmount     = document.getElementById('itemAmount');
    const itemDate       = document.getElementById('itemDate');
    const addBtn         = document.getElementById('addBtn');
    const itemsBody      = document.getElementById('itemsBody');
    const removeBtn      = document.getElementById('removeSelectedBtn');
    const exportBtn      = document.getElementById('exportCsvBtn');
    const checkAll       = document.getElementById('checkAll');
    const statusEl       = document.getElementById('status');

    // === Helpers ===
    const setStatus = (s) => statusEl.textContent = `Status: ${s}`;
    const todayStr  = () => new Date().toISOString().slice(0,10);

    function populateRows(){
      rowSelect.innerHTML = '';
      rowsList.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = r;
        rowSelect.appendChild(opt);
      });
      rowSelect.value = 'ROW1';
    }

    function renderItems(){
      itemsBody.innerHTML = '';
      currentItems.forEach((it, idx)=>{
        const tr = document.createElement('tr');

        const tdCheck = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.id = it.id;
        tdCheck.appendChild(cb);

        const tdObj = document.createElement('td');
        tdObj.textContent = it.object ?? '';

        const tdAmt = document.createElement('td');
        tdAmt.textContent = Number(it.amount ?? 0);

        const tdDate = document.createElement('td');
        tdDate.textContent = (it.added_date ?? '') || '';

        const tdAt = document.createElement('td');
        tdAt.textContent = it.added_at ? new Date(it.added_at).toLocaleString() : '';

        tr.appendChild(tdCheck);
        tr.appendChild(tdObj);
        tr.appendChild(tdAmt);
        tr.appendChild(tdDate);
        tr.appendChild(tdAt);
        itemsBody.appendChild(tr);
      });
    }

    // === Supabase I/O ===
    async function loadAll(){
      setStatus('loading...');
      const { data, error } = await supabase
        .from('inventory_items')
        .select('*')
        .order('added_at', { ascending: true });

      if(error){ setStatus('error loading'); console.error(error); return; }
      currentItems = Array.isArray(data) ? data : [];
      renderItems();
      setStatus('ready');
    }

    async function addItem(){
      const obj = itemObject.value.trim();
      if(!obj){ alert('Enter an object name'); return; }

      const dateVal = itemDate.value || todayStr();
      const amountVal = Number(itemAmount.value) || 1;

      const newItem = {
        row: rowSelect.value,
        object: obj,
        amount: amountVal,
        added_date: dateVal,
        added_at: new Date().toISOString()
      };

      setStatus('saving...');
      const { data, error } = await supabase
        .from('inventory_items')
        .insert(newItem)
        .select()
        .single();

      if(error){ setStatus('save failed'); console.error(error); return; }
      currentItems.push(data);
      renderItems();
      itemObject.value=''; itemAmount.value=1; // keep date
      setStatus('saved');
    }

    async function removeSelected(){
      const checks = Array.from(itemsBody.querySelectorAll('input[type=checkbox]:checked'));
      const ids = checks.map(c=>c.dataset.id);
      if(ids.length===0){ alert('No items selected'); return; }

      setStatus('removing...');
      const { error } = await supabase
        .from('inventory_items')
        .delete()
        .in('id', ids);

      if(error){ setStatus('remove failed'); console.error(error); return; }
      currentItems = currentItems.filter(it => !ids.includes(String(it.id)));
      renderItems();
      setStatus('removed');
      checkAll.checked = false;
    }

    function exportCSV(items){
      if(!Array.isArray(items) || items.length===0){ alert('Nothing to export'); return; }
      const headers = ['row','object','amount','added_date','added_at'];
      const rows = items.map(it => [
        it.row ?? '',
        it.object ?? '',
        it.amount ?? 0,
        it.added_date ?? '',
        it.added_at ?? ''
      ]);
      const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const csv = [headers.join(','), ...rows.map(r => r.map(esc).join(','))].join('\r\n');
      const blob = new Blob(["\uFEFF"+csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const d = new Date();
      a.href = url;
      a.download = `inventory-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // === Wire up ===
    addBtn.addEventListener('click', addItem);
    removeBtn.addEventListener('click', removeSelected);
    exportBtn.addEventListener('click', ()=>exportCSV(currentItems));
    checkAll.addEventListener('change', (e)=>{
      itemsBody.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = e.target.checked);
    });

    // === Init ===
    (function init(){
      populateRows();
      itemDate.value = todayStr();
      loadAll();
    })();
  </script>
</body>
</html>
