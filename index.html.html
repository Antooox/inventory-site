<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shared inventory — Stegra</title>

  <style>
    :root{
      --bg-grad: radial-gradient(1100px 520px at 8% -10%, #e9fbf8 0%, transparent 60%),
                 radial-gradient(900px 520px at 110% -20%, #e8f0ff 0%, transparent 60%),
                 #f7faf9;
      --card:#ffffff;
      --muted:#667272;
      --text:#0e1f1e;
      --border:#e5eeec; --border-strong:#d9e6e3;
      --primary:#0f8f83; --primary-600:#0c6f67; --primary-weak:#e8f2f1;
      --danger:#b02a2a; --danger-weak:#fdecec;
      --ok:#107a65; --ok-bg:#e9fbf6;
      --radius:16px;
      --shadow: 0 12px 36px rgba(16,24,40,.08), 0 1px 8px rgba(16,24,40,.06);
      --shadow-sm: 0 6px 18px rgba(16,24,40,.06), 0 1px 4px rgba(16,24,40,.05);
      --stripe:#fbfdfc;
    }

    html,body{height:100%}
    body{
      margin:0;background:var(--bg-grad);color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      box-sizing:border-box;
    }
    *,*:before,*:after{box-sizing:inherit}
    .wrap{max-width:1040px;margin:40px auto;padding:0 20px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px 26px}

    /* header */
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center;min-width:0}
    .logo-wrap{display:flex;align-items:center;justify-content:center;width:60px;height:60px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6)); border:1px solid var(--border); box-shadow:var(--shadow-sm); backdrop-filter: blur(6px); overflow:hidden; flex-shrink:0}
    .logo{max-width:100%;max-height:100%;object-fit:contain; transform:translateY(1px)}
    .title-wrap{min-width:0}
    h1{margin:0;font-size:38px;font-weight:800;letter-spacing:.2px;line-height:1.1}
    p.sub{margin:6px 0 0;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    label{display:block;font-weight:700;margin:14px 0 8px}
    input[type="text"],input[type="password"],input[type="date"],input[type="number"],select{
      width:100%;padding:12px 14px;border:1px solid var(--border); border-radius:12px;background:#fff;font:inherit; transition:border-color .15s, box-shadow .15s;
    }
    input:focus,select:focus{outline:none;border-color:var(--primary); box-shadow:0 0 0 4px rgb(15 143 131 / 12%)}

    /* form: Object | Date | Amount */
    .row-grid{display:grid;gap:14px;grid-template-columns:minmax(260px,1fr) 220px 140px}
    @media (max-width:820px){.row-grid{grid-template-columns:1fr}}
    @media (max-width:480px){ input, select { padding:12px } }

    .btn{display:inline-flex;align-items:center;gap:8px; padding:11px 16px;border:0;border-radius:12px;font-weight:700;cursor:pointer; line-height:1; user-select:none; transition:transform .06s ease, box-shadow .15s ease, background .15s ease}
    .btn svg{width:18px;height:18px;display:inline-block;flex-shrink:0}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow-sm)}
    .btn.primary:hover{background:var(--primary-600);transform:translateY(-1px)}
    .btn.secondary{background:var(--primary-weak);color:var(--primary)}
    .btn.secondary:hover{filter:brightness(.96)}
    .btn.link{background:transparent;border:1px solid var(--border);color:#0a5e56}
    .btn.link:hover{background:#f2fbfa}
    .btn.danger{background:#f6e8e8;color:var(--danger)}
    .btn.danger:hover{filter:brightness(.98)}
    .btn:active{transform:translateY(0)}
    .actions-top{display:flex;justify-content:space-between;gap:12px;margin-top:12px}
    .actions-row{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .right{margin-left:auto}
    @media (max-width:640px){
      .actions-top{flex-direction:column}
      .actions-top .btn{width:100%;justify-content:center}
      .actions-row{gap:10px}
      .actions-row .btn{flex:1 1 180px}
      .right{margin-left:0}
    }

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:680px}
    thead th{position:sticky;top:0;z-index:1;text-align:left;font-size:13px;color:#3b4746;background:#fbfffe;border-bottom:1px solid var(--border-strong);padding:12px 12px}
    tbody td{padding:14px 12px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--stripe)}
    tbody tr:hover{background:#f3fbf9}
    /* hide some columns on very small screens (still scrollable) */
    @media (max-width:580px){
      .col-added-at{display:none}
    }
    @media (max-width:460px){
      .col-added-date{display:none}
    }

    /* low stock styling */
    tr.low{ background: var(--danger-weak) !important; }
    tr.low .qty-value{ color: var(--danger); font-weight:800; }

    .amount-cell{display:flex;align-items:center;gap:10px}
    .qty-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer; transition:transform .05s ease, border-color .15s ease, background .15s ease}
    .qty-btn:hover{border-color:#cfe4e0;background:#f6fcfb}
    .qty-btn[disabled]{opacity:.45;cursor:not-allowed}
    .qty-btn svg{width:18px;height:18px}
    .qty-value{min-width:24px;text-align:center;font-weight:800}

    .status{display:inline-flex;align-items:center;gap:8px;margin-top:14px; font-size:13px;color:var(--muted);padding:8px 10px;border:1px solid var(--border); border-radius:999px;background:#fff}
    .status.ok{color:var(--ok);background:var(--ok-bg);border-color:#c6efe6}
    .status.err{color:var(--danger);background:var(--danger-weak);border-color:#f5cccc}

    /* login */
    .center{min-height:60vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-card{max-width:460px;width:100%}
    .login-title{font-size:28px;font-weight:800;margin:0 0 6px}
    .login-sub{color:var(--muted);margin:0 0 18px}
    .error{color:var(--danger);background:var(--danger-weak);border:1px solid #f5cccc;border-radius:10px;padding:10px;margin-top:10px;display:none}
    .login-brand{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .login-logo-wrap{display:flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6)); border:1px solid var(--border); box-shadow:var(--shadow-sm); backdrop-filter: blur(6px); overflow:hidden}
    .login-logo{max-width:100%;max-height:100%;object-fit:contain; transform:translateY(1px)}

    /* editable object */
    .obj-text{cursor:text; border-radius:6px; padding:2px 4px}
    .obj-text:hover{background:#f2fbfa; border:1px solid var(--border)}
    .obj-edit{width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px; font:inherit}
    .obj-edit:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgb(15 143 131 / 12%)}

    /* MODAL: keep hidden by default */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
    .modal-backdrop.show{display:flex !important}
    .modal{max-width:900px;width:100%;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:22px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .modal h2{margin:0;font-size:24px}
    .modal .muted{color:var(--muted);margin:0 0 12px}
    .modal-footer{display:flex;justify-content:flex-end;margin-top:14px}
    .chart-wrap{width:100%;height:520px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
    .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .legend{font-size:13px;color:var(--muted)}
    @media (max-width:640px){
      .chart-wrap{height:400px}
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginView" class="wrap center">
    <div class="card login-card">
      <div class="login-brand">
        <div class="login-logo-wrap">
          <img class="login-logo" alt="Stegra Logistics" src="https://api.zeet.se/uploads/companies/RZH4VM4sB/files/exZewH5VpU/stegrish-removebg-preview.png" />
        </div>
        <div>
          <h2 class="login-title">Stegra Logistics</h2>
          <p class="login-sub">Sign in to access the shared inventory.</p>
        </div>
      </div>

      <label for="loginUser">Username</label>
      <input id="loginUser" type="text" autocomplete="username"/>

      <label for="loginPass">Password</label>
      <input id="loginPass" type="password" placeholder="••••••••••" autocomplete="current-password"/>

      <div class="actions-top">
        <button id="loginBtn" class="btn primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10V7a5 5 0 0 1 10 0v3M6 10h12v9H6z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Sign in</span>
        </button>
        <span></span>
      </div>
      <div id="loginError" class="error">Invalid username or password.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="wrap" style="display:none">
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="logo-wrap">
            <img class="logo" alt="Stegra Logistics" src="https://api.zeet.se/uploads/companies/RZH4VM4sB/files/exZewH5VpU/stegrish-removebg-preview.png" />
          </div>
          <div class="title-wrap">
            <h1>Shared inventory</h1>
            <p class="sub">Everyone who opens this page sees the same list. Changes autosave automatically.</p>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="dashboardBtn" class="btn link" title="Open dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3v18h18M7 15v3m5-8v11m5-14v14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            <span>Dashboard</span>
          </button>
          <button id="logoutBtn" class="btn secondary" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12H3m6-6L3 12l6 6M21 3v18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Logout</span>
          </button>
        </div>
      </div>

      <div>
        <label for="rowSelect">Select row</label>
        <select id="rowSelect" aria-label="Row"></select>
      </div>

      <div class="row-grid" style="margin-top:12px">
        <div>
          <label for="itemObject">Object</label>
          <input id="itemObject" type="text" placeholder="Object — e.g. Valve ABC-123"/>
        </div>
        <div>
          <label for="itemDate">Added date</label>
          <input id="itemDate" type="date"/>
        </div>
        <div>
          <label for="itemAmount">Amount</label>
          <input id="itemAmount" type="number" min="1" step="1" value="1"/>
        </div>
      </div>

      <div class="actions-top">
        <button id="addBtn" class="btn primary" title="Add to list">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          <span>Add to list</span>
        </button>
        <span></span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:44px;"><input type="checkbox" id="checkAll" title="Select all"/></th>
              <th>Object</th>
              <th style="width:190px;">Amount</th>
              <th class="col-added-date" style="width:170px;">Added date</th>
              <th class="col-added-at" style="width:230px;">Added at</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="actions-row">
        <button id="removeSelectedBtn" class="btn danger" title="Remove selected">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          <span>Remove selected</span>
        </button>

        <div class="right">
          <button id="exportCsvBtn" class="btn secondary" title="Export CSV">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3v10m0 0l-3-3m3 3l3-3M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Export CSV</span>
          </button>
        </div>
      </div>

      <div id="status" class="status">Status: ready</div>
    </div>
  </div>

  <!-- DASHBOARD (hidden by default, toggled with .show) -->
  <div id="dashBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dashTitle">
      <div class="modal-header">
        <h2 id="dashTitle">Inventory dashboard</h2>
        <button id="dashClose" class="btn secondary" title="Close">Close</button>
      </div>
      <p class="muted">Total amount per row. Bars are <b>relative to the largest row</b> (no fixed maximum).</p>
      <div class="chart-header">
        <span class="legend" id="dashSummary">Loading…</span>
        <button id="dashRefresh" class="btn link" title="Reload data">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-2.64-6.36M21 3v6h-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          Refresh
        </button>
      </div>
      <div class="chart-wrap">
        <canvas id="dashCanvas"></canvas>
      </div>
      <div class="modal-footer">
        <button id="dashDownload" class="btn link" title="Save chart as PNG">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3v12m0 0l4-4m-4 4-4-4M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Download PNG
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ---- SIMPLE AUTH (client-gate) ---- */
    const FIXED_USER = 'stegra-logistics'; // case-insensitive
    const FIXED_PASS_SHA256 = 'b2320acb7841b387c0ad4c23bb5c41d559fe8d1192816f2c54fad279e8a8a3e6'; // "Stegra123"

    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');
    const loginBtn  = document.getElementById('loginBtn');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginErr  = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');

    function setAuthedUI(isAuthed){
      loginView.style.display = isAuthed ? 'none' : '';
      appView.style.display   = isAuthed ? '' : 'none';
    }
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }
    async function doLogin(){
      loginErr.style.display = 'none';
      const u = (loginUser.value || '').trim().toLowerCase();
      const pHash = await sha256Hex(loginPass.value || '');
      if(u === FIXED_USER && pHash === FIXED_PASS_SHA256){
        localStorage.setItem('inv_auth', JSON.stringify({u, t: Date.now()}));
        setAuthedUI(true);
        initApp();
      }else{
        loginErr.style.display = 'block';
      }
    }
    function doLogout(){
      localStorage.removeItem('inv_auth');
      setAuthedUI(false);
      loginUser.value = '';
      loginPass.value = '';
      appReady = false; // så init körs om korrekt
    }
    loginBtn.addEventListener('click', doLogin);
    loginPass.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); doLogin(); }});
    logoutBtn.addEventListener('click', doLogout);

    (function boot(){
      try{
        const s = JSON.parse(localStorage.getItem('inv_auth') || '{}');
        if(s.u === FIXED_USER){ setAuthedUI(true); initApp(); return; }
      }catch{}
      setAuthedUI(false);
    })();

    /* ---- APP ---- */
    const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';
    const TABLE = 'inventory_items';
    const LOW_STOCK_THRESHOLD = 10;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const rowsList = Array.from({length:20},(_,i)=>`ROW${i+1}`);
    let currentRow = 'ROW1';
    let currentItems = [];
    let appReady = false;  // init guard

    // DOM
    const rowSelect  = document.getElementById('rowSelect');
    const itemObject = document.getElementById('itemObject');
    const itemAmount = document.getElementById('itemAmount');
    const itemDate   = document.getElementById('itemDate');
    const addBtn     = document.getElementById('addBtn');
    const itemsBody  = document.getElementById('itemsBody');
    const checkAll   = document.getElementById('checkAll');
    const removeBtn  = document.getElementById('removeSelectedBtn');
    const exportBtn  = document.getElementById('exportCsvBtn');
    const statusEl   = document.getElementById('status');

    const setStatus = (s, type='neutral') => {
      statusEl.textContent = `Status: ${s}`;
      statusEl.classList.remove('ok','err');
      if(type==='ok') statusEl.classList.add('ok');
      if(type==='err') statusEl.classList.add('err');
    };
    const todayStr  = () => new Date().toISOString().slice(0,10);

    function renderItems(){
      itemsBody.innerHTML = '';
      currentItems.forEach(it=>{
        const tr = document.createElement('tr');
        const isLow = Number(it.amount ?? 0) < LOW_STOCK_THRESHOLD;
        if (isLow) tr.classList.add('low');

        const tdCheck = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.id = it.id;
        tdCheck.appendChild(cb);

        const tdObj = document.createElement('td');
        const objSpan = document.createElement('span');
        objSpan.className = 'obj-text';
        objSpan.dataset.id = it.id;
        objSpan.textContent = it.object ?? '';
        tdObj.appendChild(objSpan);

        const tdAmt = document.createElement('td');
        tdAmt.className = 'amount-cell';
        const decBtn = document.createElement('button');
        decBtn.className = 'qty-btn';
        decBtn.dataset.action='dec'; decBtn.dataset.id = it.id;
        decBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;
        const valSpan = document.createElement('span');
        valSpan.className='qty-value'; valSpan.dataset.valId = it.id;
        valSpan.textContent = Number(it.amount ?? 0);
        const incBtn = document.createElement('button');
        incBtn.className='qty-btn'; incBtn.dataset.action='inc'; incBtn.dataset.id = it.id;
        incBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;
        tdAmt.append(decBtn,valSpan,incBtn);

        const tdDate= document.createElement('td');
        tdDate.className='col-added-date';
        tdDate.textContent = it.added_date ?? '';

        const tdAt  = document.createElement('td');
        tdAt.className='col-added-at';
        tdAt.textContent = it.added_at ? new Date(it.added_at).toLocaleString() : '';

        tr.append(tdCheck, tdObj, tdAmt, tdDate, tdAt);
        itemsBody.appendChild(tr);

        decBtn.disabled = Number(it.amount ?? 0) <= 1;
      });
    }

    async function loadForRow(row){
      setStatus(`loading ${row}...`);
      const { data, error } = await supabase
        .from(TABLE).select('id,row,object,amount,added_date,added_at')
        .eq('row', row)
        .order('added_at',{ascending:true});
      if(error){ setStatus(`error loading: ${error.message}`,'err'); console.error(error); return; }
      currentItems = Array.isArray(data) ? data : [];
      renderItems();
      setStatus('ready','ok');
    }

    async function addItem(){
      const obj = (itemObject.value || '').trim();
      if(!obj){ alert('Enter an object name'); return; }
      const dateVal = itemDate.value || todayStr();
      const amountVal = Math.max(1, Number(itemAmount.value) || 1);

      const newItem = {
        id: (crypto?.randomUUID?.() || String(Date.now())),
        row: currentRow,
        object: obj,
        amount: amountVal,
        added_date: dateVal,
        added_at: new Date().toISOString()
      };

      setStatus('saving...');
      const { data, error } = await supabase.from(TABLE).insert(newItem).select().maybeSingle();
      if(error){ setStatus(`save failed: ${error.message}`,'err'); console.error(error); return; }

      if(currentRow === newItem.row){
        currentItems.push(data || newItem);
        renderItems();
      }
      itemObject.value=''; itemAmount.value=1;
      setStatus('saved','ok');
    }

    async function updateAmount(id, delta){
      const idx = currentItems.findIndex(x => String(x.id) === String(id));
      if(idx === -1) return;
      const newVal = Math.max(1, Number(currentItems[idx].amount || 0) + delta);

      currentItems[idx].amount = newVal;  // optimistic
      renderItems();

      setStatus('updating amount...');
      const { error } = await supabase
        .from(TABLE).update({ amount: newVal })
        .eq('id', id).eq('row', currentRow);
      if(error){
        setStatus(`update failed: ${error.message}`,'err');
        currentItems[idx].amount = Math.max(1, newVal - delta); // revert
        renderItems();
        return;
      }
      setStatus('updated','ok');
    }

    async function renameObject(id, newName, revert){
      const idx = currentItems.findIndex(x => String(x.id) === String(id));
      if(idx === -1) return;
      const old = currentItems[idx].object || '';
      const name = (newName || '').trim();
      if(name === '' || name === old){ revert(old); return; }

      currentItems[idx].object = name; // optimistic
      renderItems();

      setStatus('renaming...');
      const { error } = await supabase
        .from(TABLE).update({ object: name })
        .eq('id', id).eq('row', currentRow);
      if(error){
        currentItems[idx].object = old; // revert
        renderItems();
        setStatus(`rename failed: ${error.message}`,'err');
        return;
      }
      setStatus('updated','ok');
    }

    async function removeSelected(){
      const checks = Array.from(itemsBody.querySelectorAll('input[type=checkbox]:checked'));
      const ids = checks.map(c=>c.dataset.id);
      if(ids.length===0){ alert('No items selected'); return; }

      setStatus('removing...');
      const { error } = await supabase.from(TABLE).delete().in('id', ids).eq('row', currentRow);
      if(error){ setStatus(`remove failed: ${error.message}`,'err'); console.error(error); return; }

      currentItems = currentItems.filter(it => !ids.includes(String(it.id)));
      renderItems();
      checkAll.checked = false;
      setStatus('removed','ok');
    }

    function exportCSV(items){
      if(!Array.isArray(items) || items.length===0){ alert('Nothing to export'); return; }
      const headers = ['row','object','amount','added_date','added_at'];
      const rows = items.map(it => [it.row ?? '', it.object ?? '', it.amount ?? 0, it.added_date ?? '', it.added_at ?? '']);
      const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const csv = [headers.join(','), ...rows.map(r => r.map(esc).join(','))].join('\r\n');
      const blob = new Blob(["\uFEFF"+csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const d = new Date();
      a.href = url;
      a.download = `inventory-${currentRow}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function wireMainEvents(){
      addBtn.addEventListener('click', addItem);
      removeBtn.addEventListener('click', removeSelected);
      exportBtn.addEventListener('click', ()=>exportCSV(currentItems));
      checkAll.addEventListener('change', (e)=>{
        itemsBody.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = e.target.checked);
      });

      // plus/minus
      itemsBody.addEventListener('click', (e)=>{
        const btn = e.target.closest('.qty-btn');
        if(!btn) return;
        const id = btn.dataset.id;
        const act = btn.dataset.action;
        updateAmount(id, act==='inc' ? +1 : -1);
      });

      // inline rename
      itemsBody.addEventListener('click', (e)=>{
        const span = e.target.closest('.obj-text');
        if(!span) return;

        const id = span.dataset.id;
        const oldText = span.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldText;
        input.className = 'obj-edit';

        span.replaceWith(input);
        input.focus(); input.select();

        const revert = (txt)=>{ input.replaceWith(Object.assign(document.createElement('span'), {className:'obj-text', dataset:{id}, textContent:txt})); };
        const save = ()=> renameObject(id, input.value, revert);
        const cancel = ()=> revert(oldText);

        input.addEventListener('keydown', (ev)=>{
          if(ev.key === 'Enter'){ ev.preventDefault(); save(); }
          else if(ev.key === 'Escape'){ ev.preventDefault(); cancel(); }
        });
        input.addEventListener('blur', save);
      });

      rowSelect.addEventListener('change', async (e)=>{
        currentRow = e.target.value;
        checkAll.checked = false;
        await loadForRow(currentRow);
      });

      // DASHBOARD open/close/refresh
      document.getElementById('dashboardBtn').addEventListener('click', async () => { openDashboard(); await loadDashboard(); });
      document.getElementById('dashClose').addEventListener('click', closeDashboard);
      document.getElementById('dashRefresh').addEventListener('click', loadDashboard);
      document.getElementById('dashDownload').addEventListener('click', downloadChart);
      document.getElementById('dashBackdrop').addEventListener('click', (e)=>{ if(e.target === dashBackdrop) closeDashboard(); });
    }

    /* ---- Dashboard ---- */
    const dashBackdrop = document.getElementById('dashBackdrop');
    const dashClose    = document.getElementById('dashClose');
    const dashRefresh  = document.getElementById('dashRefresh');
    const dashDownload = document.getElementById('dashDownload');
    const dashSummary  = document.getElementById('dashSummary');
    const dashCanvas   = document.getElementById('dashCanvas');
    let dashData = []; let resizeHandler = null;

    function openDashboard(){ dashBackdrop.classList.add('show'); }
    function closeDashboard(){ dashBackdrop.classList.remove('show'); if(resizeHandler){ window.removeEventListener('resize', resizeHandler); resizeHandler=null; } }

    async function loadDashboard(){
      setStatus('loading dashboard...');
      const { data, error } = await supabase.from(TABLE).select('row,amount');
      if(error){ setStatus(`dashboard error: ${error.message}`,'err'); console.error(error); return; }
      const agg={}; for(const r of rowsList) agg[r]=0;
      for(const it of (data||[])){ const r=it.row||'UNKNOWN'; if(!(r in agg)) agg[r]=0; agg[r]+=Number(it.amount||0); }
      dashData = Object.entries(agg).map(([row,amount])=>({row,amount})).sort((a,b)=>b.amount-a.amount);
      dashSummary.textContent = `Rows: ${dashData.length} • Total amount: ${dashData.reduce((s,x)=>s+x.amount,0)}`;
      drawBarChart(); if(!resizeHandler){ resizeHandler=()=>drawBarChart(); window.addEventListener('resize',resizeHandler); }
      setStatus('dashboard ready','ok');
    }
    function drawBarChart(){
      const ctx = dashCanvas.getContext('2d'), parent = dashCanvas.parentElement, dpr = Math.max(1, window.devicePixelRatio||1);
      const padL=100,padR=24,padT=24,padB=24, gap=10, barH=22;
      const count=dashData.length, needH=padT+padB+count*barH+Math.max(0,(count-1))*gap;
      const cssW = Math.max(300, parent.clientWidth), cssH = Math.max(260, Math.min(720, needH));
      dashCanvas.style.width=cssW+'px'; dashCanvas.style.height=cssH+'px'; dashCanvas.width=Math.floor(cssW*dpr); dashCanvas.height=Math.floor(cssH*dpr);
      ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,cssW,cssH);
      ctx.font='13px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif';
      const maxAmt = Math.max(1, ...dashData.map(x=>x.amount)), chartW = cssW - padL - padR;
      ctx.strokeStyle='#e5eeec'; ctx.beginPath(); ctx.moveTo(padL,padT-6); ctx.lineTo(padL,cssH-padB); ctx.stroke();
      dashData.forEach((d,i)=>{ const y=padT+i*(barH+gap); ctx.fillStyle='#3b4746'; ctx.textAlign='left'; ctx.fillText(d.row,12,y+barH-6);
        const w= maxAmt===0?0:Math.round((d.amount/maxAmt)*chartW); ctx.fillStyle='#0f8f83'; roundRect(ctx,padL,y,w,barH,6,true,false);
        ctx.fillStyle='#0e1f1e'; ctx.fillText(String(d.amount), padL+w+6, y+barH-6); });
      function roundRect(ctx,x,y,w,h,r,fill,stroke){ if(w<=0||h<=0) return; if(r>h/2) r=h/2; if(r>w/2) r=w/2; ctx.beginPath();
        ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
    }
    function downloadChart(){
      const a=document.createElement('a');
      a.download=`inventory-dashboard-${new Date().toISOString().slice(0,10)}.png`;
      a.href=dashCanvas.toDataURL('image/png'); document.body.appendChild(a); a.click(); a.remove();
    }

    /* INIT */
    async function initApp(){
      if (appReady) return;
      appReady = true;

      rowSelect.innerHTML = rowsList.map(r=>`<option value="${r}">${r}</option>`).join('');
      rowSelect.value = currentRow;
      itemDate.value = todayStr();

      wireMainEvents();
      await loadForRow(currentRow);
    }
  </script>
</body>
</html>
