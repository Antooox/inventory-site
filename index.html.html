<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shared inventory (Supabase) — autosave</title>
<style>
:root{--accent:#16a085;--danger:#e04e4e;--muted:#6b7280}
body{font-family:Inter,system-ui,Arial;margin:24px;background:#f6f8fa;color:#111}
.container{max-width:980px;margin:0 auto}
.card{background:#fff;border-radius:12px;padding:22px;box-shadow:0 10px 30px rgba(10,20,30,.06)}
h1{margin:0 0 6px;font-size:26px}
.lead{margin:0 0 16px;color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:14px}
.controls > *{flex:0}
.input{padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:14px}
.input.flex{flex:1}
.btn{background:var(--accent);color:#fff;padding:9px 14px;border-radius:8px;border:0;cursor:pointer}
.btn.secondary{background:#fff;border:1px solid #e6e9ee;color:#111}
.btn.danger{background:var(--danger);color:#fff}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:12px;border-bottom:1px solid #f2f4f7;text-align:left}
th{font-weight:700}
.small{font-size:13px;color:var(--muted)}
.amount-controls{display:inline-flex;align-items:center;gap:6px}
.smallbtn{padding:6px 8px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;cursor:pointer}
.toolbar{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
.status{margin-top:12px;color:var(--muted);font-size:13px}
.hidden{display:none}
@media(max-width:720px){.controls{flex-direction:column;align-items:stretch}.input{width:100%}}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Shared inventory</h1>
    <p class="lead">Everyone who opens this page sees the same list. Changes autosave automatically.</p>

    <div class="controls">
      <input id="inputObject" class="input flex" type="text" placeholder="Object — e.g. Valve ABC-123"/>
      <input id="inputDate" class="input" type="date"/>
      <input id="inputAmount" class="input" type="number" min="1" value="1" style="width:96px"/>
      <button id="btnAdd" class="btn">Add to list</button>
    </div>

    <table class="table" aria-live="polite">
      <thead>
        <tr>
          <th style="width:36px"><input id="chkAll" type="checkbox" /></th>
          <th>Object</th>
          <th style="width:160px">Amount</th>
          <th style="width:140px">Added date</th>
          <th style="width:220px">Added at</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" class="small">No items yet</td></tr>
      </tbody>
    </table>

    <div class="toolbar">
      <button id="btnRemoveSelected" class="btn danger">Remove selected</button>
      <button id="btnUndo" class="btn secondary">Undo remove</button>
      <button id="btnExport" class="btn secondary">Export CSV</button>
      <div id="shareArea" style="margin-left:auto" class="small"></div>
    </div>

    <div id="status" class="status">Initializing…</div>
  </div>
</div>

<script>
/* ========== CONFIG (inlined as requested) ========== */
const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';
const ROW_NAME = 'row1_logistics'; // single shared row

/* ========== DOM ========== */
const inputObject = document.getElementById('inputObject');
const inputDate = document.getElementById('inputDate');
const inputAmount = document.getElementById('inputAmount');
const btnAdd = document.getElementById('btnAdd');
const tbody = document.getElementById('tbody');
const status = document.getElementById('status');
const btnRemoveSelected = document.getElementById('btnRemoveSelected');
const btnUndo = document.getElementById('btnUndo');
const btnExport = document.getElementById('btnExport');
const chkAll = document.getElementById('chkAll');
const shareArea = document.getElementById('shareArea');

/* ========== State ========== */
let rowId = null;        // uuid of the lists row
let items = [];          // array of {id,obj,amount,date,added_at, removed:false}
let lastRemoved = [];    // for undo
let saving = false;

/* ========== Helpers ========== */
const headers = () => ({
  'apikey': SUPABASE_KEY,
  'Authorization': 'Bearer ' + SUPABASE_KEY,
  'Content-Type': 'application/json'
});

function uid(len=8){
  const a = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let s=''; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)];
  return s;
}

function isoNow(){ return new Date().toISOString(); }
function formatDateLocal(d){ // yyyy-mm-dd
  if(!d) return '';
  const dt = new Date(d);
  const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function humanTime(d){
  if(!d) return '';
  return new Date(d).toLocaleString();
}

/* ========== Rendering ========== */
function render(){
  tbody.innerHTML = '';
  if(!items.length){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="5" class="small">No items yet</td>';
    tbody.appendChild(tr);
    return;
  }
  items.forEach(it => {
    if(it._removed) return; // skip removed (but kept in lastRemoved)
    const tr = document.createElement('tr');
    tr.dataset.id = it.id;
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="${it.id}" /></td>
      <td>${escapeHtml(it.object)}</td>
      <td>
        <div class="amount-controls">
          <button class="smallbtn dec" data-id="${it.id}">-</button>
          <div style="min-width:34px;text-align:center">${it.amount}</div>
          <button class="smallbtn inc" data-id="${it.id}">+</button>
        </div>
      </td>
      <td>${escapeHtml(it.date||'')}</td>
      <td class="small">${escapeHtml(it.added_at?humanTime(it.added_at):'')}</td>
    `;
    tbody.appendChild(tr);
  });
  attachRowHandlers();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

function setStatus(txt, err=false){
  status.textContent = txt;
  status.style.color = err ? 'var(--danger)' : 'var(--muted)';
}

/* ========== Supabase REST helpers ========== */
async function apiGetRow(){
  const url = `${SUPABASE_URL}/rest/v1/lists?row=eq.${encodeURIComponent(ROW_NAME)}&select=*`;
  const r = await fetch(url, { method:'GET', headers: headers() });
  if(!r.ok) throw new Error(`GET failed ${r.status}`);
  return r.json();
}

async function apiCreateRow(){
  const url = `${SUPABASE_URL}/rest/v1/lists`;
  const body = { row: ROW_NAME, items: [] };
  const r = await fetch(url, { method:'POST', headers: {...headers(),'Prefer':'return=representation'}, body: JSON.stringify(body) });
  if(!r.ok) {
    const txt = await r.text();
    throw new Error(`POST failed ${r.status} ${txt}`);
  }
  return r.json();
}

async function apiPatchRow(id, newItems){
  const url = `${SUPABASE_URL}/rest/v1/lists?id=eq.${encodeURIComponent(id)}`;
  const body = { items: newItems };
  const r = await fetch(url, { method:'PATCH', headers: {...headers(), 'Prefer':'return=representation'}, body: JSON.stringify(body) });
  const txt = await r.text();
  if(!r.ok) throw new Error(`PATCH failed ${r.status} ${txt}`);
  return JSON.parse(txt);
}

/* ========== Load or create shared row ========== */
async function init(){
  setStatus('Loading shared list...');
  try{
    const rows = await apiGetRow();
    if(rows && rows.length){
      const r = rows[0];
      rowId = r.id;
      items = (r.items || []).map(it => ({...it}));
      setStatus('Loaded list from cloud.');
    } else {
      // create initial row
      const created = await apiCreateRow();
      rowId = created[0].id;
      items = [];
      setStatus('Created shared list (empty).');
    }
    render();
  }catch(err){
    console.error(err);
    setStatus('Failed to load or create row: ' + err.message, true);
  }
}

/* ========== Save: patch the row items array ========== */
let saveTimer = null;
function scheduleSave(immediate=false){
  if(saveTimer) clearTimeout(saveTimer);
  if(immediate){
    doSave();
  } else {
    saveTimer = setTimeout(doSave, 400);
  }
}

async function doSave(){
  if(!rowId){ setStatus('No row id — cannot save', true); return; }
  saving = true;
  setStatus('Saving…');
  const toSave = items.filter(i => !i._removed).map(i => ({
    id: i.id, object: i.object, amount: i.amount, date: i.date, added_at: i.added_at
  }));
  try{
    await apiPatchRow(rowId, toSave);
    saving = false;
    setStatus('Saved at ' + new Date().toLocaleTimeString());
  }catch(err){
    saving = false;
    console.error('save error', err);
    setStatus('Save failed: ' + err.message, true);
  }
}

/* ========== UI actions: add, inc/dec, remove, undo ========== */
btnAdd.addEventListener('click', async ()=>{
  const obj = (inputObject.value||'').trim();
  if(!obj){ inputObject.focus(); return; }
  const dt = inputDate.value ? inputDate.value : formatDateLocal(new Date());
  const amount = Math.max(1, parseInt(inputAmount.value) || 1);
  const it = { id: uid(12), object: obj, amount: amount, date: dt, added_at: isoNow() };
  items.push(it);
  render();
  inputObject.value = ''; inputAmount.value = '1';
  scheduleSave(); // autosave
});

function attachRowHandlers(){
  // inc / dec
  document.querySelectorAll('.inc').forEach(b=>{
    b.onclick = (e)=>{
      const id = b.dataset.id;
      const it = items.find(x=>x.id===id); if(!it) return;
      it.amount = Number(it.amount||0) + 1;
      render();
      scheduleSave();
    };
  });
  document.querySelectorAll('.dec').forEach(b=>{
    b.onclick = (e)=>{
      const id = b.dataset.id;
      const it = items.find(x=>x.id===id); if(!it) return;
      it.amount = Math.max(1, Number(it.amount||0) - 1);
      render();
      scheduleSave();
    };
  });
  // checkboxes
  document.querySelectorAll('.rowchk').forEach(cb=>{
    cb.onchange = ()=>{ /* nothing immediate */ };
  });
}

/* Remove selected */
btnRemoveSelected.addEventListener('click', ()=>{
  const checks = Array.from(document.querySelectorAll('.rowchk')).filter(c=>c.checked);
  if(!checks.length){ alert('No rows selected'); return; }
  lastRemoved = checks.map(c=>{
    const id = c.dataset.id;
    const it = items.find(x=>x.id===id);
    if(it) { it._removed = true; return it; }
    return null;
  }).filter(Boolean);
  render();
  scheduleSave();
  setStatus(`${lastRemoved.length} removed — click Undo remove to restore`);
});

/* Undo */
btnUndo.addEventListener('click', ()=>{
  if(!lastRemoved.length){ setStatus('Nothing to undo'); return; }
  lastRemoved.forEach(r=>{
    const idx = items.findIndex(x=>x.id===r.id);
    if(idx>=0) items[idx]._removed = false;
    else items.push(r);
  });
  lastRemoved = [];
  render();
  scheduleSave();
});

/* Export CSV */
btnExport.addEventListener('click', ()=>{
  if(!items.length){ alert('No items'); return; }
  const rows = items.filter(i=>!i._removed).map(i => [i.object, i.amount, i.date, i.added_at]);
  const csv = ['Object,Amount,Added date,Added at', ...rows.map(r => r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'inventory.csv'; document.body.appendChild(a); a.click(); a.remove();
});

/* select all checkbox */
chkAll.addEventListener('change', ()=>{
  const on = chkAll.checked;
  document.querySelectorAll('.rowchk').forEach(c=>c.checked = on);
});

/* ========== Init flow ========== */
(async function(){
  setStatus('Initializing connection to Supabase...');
  try{
    // quick check: try GET, if 200 proceed
    await init();
  }catch(err){
    console.error(err);
    setStatus('Initialization failed: ' + err.message, true);
  }
})();

/* Save beforeunload (best-effort) */
window.addEventListener('beforeunload', function(e){
  if(saving) return;
  if(items.length) navigator.sendBeacon && navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/lists?id=eq.${encodeURIComponent(rowId)}`, JSON.stringify({ items: items.filter(i=>!i._removed) }));
});

/* optional: keep UI live by polling occasionally in case others update the shared list */
setInterval(async ()=>{
  try{
    const rows = await apiGetRow();
    if(rows && rows.length){
      const r = rows[0];
      // simple merge: if cloud's items differ from local and local hasn't edited recently, replace
      const cloud = r.items || [];
      // quick compare by JSON
      const localJson = JSON.stringify(items.filter(i=>!i._removed).map(i=>({...i})));
      const cloudJson = JSON.stringify(cloud);
      if(localJson !== cloudJson){
        // update local to cloud state
        items = cloud.map(it=>({...it}));
        render();
        setStatus('List updated from cloud (remote changes).');
      }
    }
  }catch(e){
    // ignore silently
  }
}, 5000);

</script>
</body>
</html>
