<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shared inventory</title>
  <style>
    :root{
      --bg:#f7faf9; --card:#ffffff; --muted:#6b7b7a;
      --primary:#0f8f83; --primary-weak:#e8f2f1;
      --danger:#b02a2a; --danger-weak:#f6e8e8;
      --border:#e6eeec; --text:#0f1f1e; --radius:14px;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; box-sizing:border-box}
    *,*:before,*:after{box-sizing:inherit}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px}
    h1{margin:0 0 6px 0;font-size:38px;font-weight:800;letter-spacing:.2px}
    p.sub{margin:0 0 22px 0;color:var(--muted)}
    label{display:block;font-weight:700;margin:14px 0 6px}
    input[type="text"],input[type="date"],input[type="number"],select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit
    }

    /* Form row: Object | Date | Amount */
    .row-grid{
      display:grid;
      grid-template-columns: minmax(240px, 1fr) 220px 130px;
      gap:14px;
    }
    @media (max-width:760px){ .row-grid{grid-template-columns:1fr} }

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:11px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer;
      line-height:1; user-select:none;
    }
    .btn svg{width:18px;height:18px;display:inline-block;flex-shrink:0}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--primary-weak);color:var(--primary)}
    .btn.danger{background:var(--danger-weak);color:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .actions-top{display:flex;justify-content:flex-end;margin-top:10px}
    .actions-row{display:flex;gap:12px;align-items:center;margin-top:12px}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:14px}
    thead th{text-align:left;font-size:14px;color:var(--muted);border-bottom:1px solid var(--border);padding:10px 10px}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}

    .amount-cell{display:flex;align-items:center;gap:8px}
    .qty-btn{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;
    }
    .qty-btn[disabled]{opacity:.5;cursor:not-allowed}
    .qty-btn svg{width:16px;height:16px}
    .qty-value{min-width:20px;text-align:center}

    .status{color:var(--muted);font-size:13px;margin-top:10px}
    .status.error{color:#a11}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Shared inventory</h1>
      <p class="sub">Everyone who opens this page sees the same list. Changes autosave automatically.</p>

      <div>
        <label for="rowSelect">Select row</label>
        <select id="rowSelect" aria-label="Row"></select>
      </div>

      <div class="row-grid" style="margin-top:10px">
        <div>
          <label for="itemObject">Object</label>
          <input id="itemObject" type="text" placeholder="Object — e.g. Valve ABC-123"/>
        </div>
        <div>
          <label for="itemDate">Added date</label>
          <input id="itemDate" type="date"/>
        </div>
        <div>
          <label for="itemAmount">Amount</label>
          <input id="itemAmount" type="number" min="1" step="1" value="1"/>
        </div>
      </div>

      <div class="actions-top">
        <button id="addBtn" class="btn primary" title="Add to list">
          <!-- PLUS ICON -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          <span>Add to list</span>
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40px;"><input type="checkbox" id="checkAll" title="Select all"/></th>
            <th>Object</th>
            <th style="width:170px;">Amount</th>
            <th style="width:160px;">Added date</th>
            <th style="width:220px;">Added at</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>

      <div class="actions-row">
        <button id="removeSelectedBtn" class="btn danger" title="Remove selected">
          <!-- MINUS ICON -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          <span>Remove selected</span>
        </button>

        <div class="right">
          <button id="exportCsvBtn" class="btn secondary" title="Export CSV">
            <!-- EXPORT ICON -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 3v10m0 0l-3-3m3 3l3-3M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Export CSV</span>
          </button>
        </div>
      </div>

      <div id="status" class="status">Status: ready</div>
    </div>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /******** CONFIG ********/
    const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';
    const TABLE = 'inventory_items';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /******** STATE ********/
    const rowsList = Array.from({length:20},(_,i)=>`ROW${i+1}`);
    let currentRow = 'ROW1';
    let currentItems = []; // bara för aktuell rad

    /******** UI refs ********/
    const rowSelect  = document.getElementById('rowSelect');
    const itemObject = document.getElementById('itemObject');
    const itemAmount = document.getElementById('itemAmount');
    const itemDate   = document.getElementById('itemDate');
    const addBtn     = document.getElementById('addBtn');

    const itemsBody  = document.getElementById('itemsBody');
    const checkAll   = document.getElementById('checkAll');
    const removeBtn  = document.getElementById('removeSelectedBtn');
    const exportBtn  = document.getElementById('exportCsvBtn');
    const statusEl   = document.getElementById('status');

    const setStatus = (s, isError=false) => {
      statusEl.textContent = `Status: ${s}`;
      statusEl.classList.toggle('error', !!isError);
      console.log('[STATUS]', s);
    };
    const todayStr  = () => new Date().toISOString().slice(0,10);

    /******** UI helpers ********/
    function populateRows(){
      rowSelect.innerHTML = rowsList.map(r=>`<option value="${r}">${r}</option>`).join('');
      rowSelect.value = currentRow;
    }

    function renderItems(){
      itemsBody.innerHTML = '';
      currentItems.forEach(it=>{
        const tr = document.createElement('tr');

        // checkbox
        const tdCheck = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.id = it.id;
        tdCheck.appendChild(cb);

        // object
        const tdObj = document.createElement('td');  tdObj.textContent = it.object ?? '';

        // amount + +/- controls
        const tdAmt = document.createElement('td');
        tdAmt.className = 'amount-cell';

        const decBtn = document.createElement('button');
        decBtn.className = 'qty-btn';
        decBtn.setAttribute('data-action','dec');
        decBtn.setAttribute('data-id', it.id);
        decBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;

        const valSpan = document.createElement('span');
        valSpan.className = 'qty-value';
        valSpan.setAttribute('data-val-id', it.id);
        valSpan.textContent = Number(it.amount ?? 0);

        const incBtn = document.createElement('button');
        incBtn.className = 'qty-btn';
        incBtn.setAttribute('data-action','inc');
        incBtn.setAttribute('data-id', it.id);
        incBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;

        tdAmt.appendChild(decBtn);
        tdAmt.appendChild(valSpan);
        tdAmt.appendChild(incBtn);

        // dates
        const tdDate= document.createElement('td');  tdDate.textContent = it.added_date ?? '';
        const tdAt  = document.createElement('td');  tdAt.textContent = it.added_at ? new Date(it.added_at).toLocaleString() : '';

        tr.appendChild(tdCheck); tr.appendChild(tdObj); tr.appendChild(tdAmt); tr.appendChild(tdDate); tr.appendChild(tdAt);
        itemsBody.appendChild(tr);

        // disable minus if 1
        decBtn.disabled = Number(it.amount ?? 0) <= 1;
      });
    }

    /******** Supabase I/O ********/
    async function loadForRow(row){
      setStatus(`loading ${row}...`);
      const { data, error } = await supabase
        .from(TABLE)
        .select('*')
        .eq('row', row)              // <-- filtrera på vald rad
        .order('added_at',{ascending:true});

      if(error){ setStatus(`error loading: ${error.message}`, true); console.error(error); return; }
      currentItems = Array.isArray(data) ? data : [];
      renderItems();
      setStatus('ready');
    }

    async function addItem(){
      const obj = itemObject.value.trim();
      if(!obj){ alert('Enter an object name'); return; }
      const dateVal = itemDate.value || todayStr();
      const amountVal = Math.max(1, Number(itemAmount.value) || 1);

      const newItem = {
        id: (crypto?.randomUUID?.() || String(Date.now())),
        row: currentRow,                // <-- bind till vald rad
        object: obj,
        amount: amountVal,
        added_date: dateVal,
        added_at: new Date().toISOString()
      };

      setStatus('saving...');
      const { data, error } = await supabase.from(TABLE).insert(newItem).select().maybeSingle();
      if(error){ setStatus(`save failed: ${error.message}`, true); console.error('Supabase insert error:', error); return; }

      // lägg bara till i listan om vi står kvar på samma rad
      if (currentRow === newItem.row) {
        currentItems.push(data || newItem);
        renderItems();
      }
      itemObject.value=''; itemAmount.value=1;
      setStatus('saved');
    }

    async function updateAmount(id, delta){
      const idx = currentItems.findIndex(x => String(x.id) === String(id));
      if(idx === -1) return;
      const newVal = Math.max(1, Number(currentItems[idx].amount || 0) + delta);

      // Optimistic UI
      currentItems[idx].amount = newVal;
      const span = document.querySelector(`[data-val-id="${id}"]`);
      if(span) span.textContent = newVal;
      const decBtn = itemsBody.querySelector(`.qty-btn[data-action="dec"][data-id="${id}"]`);
      if(decBtn) decBtn.disabled = newVal <= 1;

      setStatus('updating amount...');
      const { data, error } = await supabase
        .from(TABLE)
        .update({ amount: newVal })
        .eq('id', id)
        .eq('row', currentRow)    // säkerställ rätt rad
        .select()
        .maybeSingle();

      if(error){
        setStatus(`update failed: ${error.message}`, true);
        console.error(error);
        // rollback
        const rolled = Math.max(1, newVal - delta);
        currentItems[idx].amount = rolled;
        if(span) span.textContent = rolled;
        if(decBtn) decBtn.disabled = rolled <= 1;
        return;
      }
      if(data){ currentItems[idx] = { ...currentItems[idx], ...data }; }
      setStatus('updated');
    }

    async function removeSelected(){
      const checks = Array.from(itemsBody.querySelectorAll('input[type=checkbox]:checked'));
      const ids = checks.map(c=>c.dataset.id);
      if(ids.length===0){ alert('No items selected'); return; }

      setStatus('removing...');
      const { error } = await supabase.from(TABLE)
        .delete()
        .in('id', ids)
        .eq('row', currentRow);   // extra guard

      if(error){ setStatus(`remove failed: ${error.message}`, true); console.error(error); return; }

      currentItems = currentItems.filter(it => !ids.includes(String(it.id)));
      renderItems();
      checkAll.checked = false;
      setStatus('removed');
    }

    function exportCSV(items){
      if(!Array.isArray(items) || items.length===0){ alert('Nothing to export'); return; }
      const headers = ['row','object','amount','added_date','added_at'];
      const rows = items.map(it => [it.row ?? '', it.object ?? '', it.amount ?? 0, it.added_date ?? '', it.added_at ?? '']);
      const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const csv = [headers.join(','), ...rows.map(r => r.map(esc).join(','))].join('\r\n');
      const blob = new Blob(["\uFEFF"+csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const d = new Date();
      a.href = url;
      a.download = `inventory-${currentRow}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    /******** Wire up ********/
    addBtn.addEventListener('click', addItem);
    removeBtn.addEventListener('click', removeSelected);
    exportBtn.addEventListener('click', ()=>exportCSV(currentItems));
    checkAll.addEventListener('change', (e)=>{
      itemsBody.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = e.target.checked);
    });
    itemsBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('.qty-btn');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-action');
      updateAmount(id, act==='inc' ? +1 : -1);
    });
    rowSelect.addEventListener('change', async ()=>{
      currentRow = rowSelect.value;
      checkAll.checked = false;
      await loadForRow(currentRow);   // ladda endast denna rad
    });

    /******** Init ********/
    (async function init(){
      currentRow = 'ROW1';
      populateRows();
      itemDate.value = todayStr();
      await loadForRow(currentRow);
    })();
  </script>
</body>
</html>
