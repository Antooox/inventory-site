<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory — dropdown fix</title>
  <style>
    body { font-family: Inter, Arial, Helvetica, sans-serif; padding:20px; background:#f6f7f9; color:#222 }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:520px }
    label { display:block; margin-bottom:8px; font-weight:600 }
    select { width:100%; padding:8px 12px; border-radius:6px; border:1px solid #d8dce0 }
    button { margin-top:12px; padding:8px 12px; border-radius:6px; border:none; cursor:pointer }
    .muted { color:#6b7280; font-size:13px; margin-top:8px }
    pre { background:#111; color:#fff; padding:8px; border-radius:6px; overflow:auto; max-height:120px }
  </style>
</head>
<body>
  <div class="card">
    <label for="rowSelect">Select row</label>
    <select id="rowSelect">
      <option value="">Laddar...</option>
    </select>

    <div>
      <button id="refreshBtn">Hämta igen (force)</button>
    </div>

    <p class="muted">Öppna webbläsarens Console för mer logg (F12). Se "Fetched rows" och "uniqueCount".</p>
  </div>

  <!-- Byt ut dessa med din Supabase-url och anon-key -->
  <script type="module">
    // --- CONFIG ---
    const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co'; // ersätt
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY'; // ersätt

    // --- IMPORT SUPABASE CLIENT FROM CDN (ingen build behövs) ---
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Enkel guard så dropdown inte fylls av misstag två gånger ---
    window._rowsLoaded = false;

    // loadRows: hämtar, deduplikar på row_name och renderar
    async function loadRows(force = false) {
      if (window._rowsLoaded && !force) {
        console.log('loadRows: redan inläst — använd refresh för att tvinga om');
        return;
      }

      console.trace('loadRows called'); // om du ser flera traces vet du att funktionen körs flera gånger

      const { data, error } = await supabase
        .from('rows_table') // byt till ditt tabellnamn
        .select('id, row_name')
        .order('row_name', { ascending: true });

      if (error) {
        console.error('Supabase error', error);
        const sel = document.getElementById('rowSelect');
        sel.innerHTML = '<option value="">Fel vid hämtning</option>';
        return;
      }

      console.log('Fetched rows', data);

      // Dedupe baserat på row_name (behåller första förekomsten)
      const uniqueMap = new Map();
      for (const item of data) {
        if (!uniqueMap.has(item.row_name)) uniqueMap.set(item.row_name, item);
      }
      const unique = [...uniqueMap.values()];

      console.log('uniqueCount:', unique.length, 'rawCount:', data.length);
      if (unique.length !== data.length) console.warn('Dubbletter hittades i svaret och togs bort (client-side)');

      // Rendera dropdown
      const sel = document.getElementById('rowSelect');
      sel.innerHTML = '';
      if (unique.length === 0) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'Inga rader';
        sel.appendChild(o);
      } else {
        unique.forEach(r => {
          const o = document.createElement('option');
          o.value = r.id; // använd id om du vill
          o.textContent = r.row_name;
          sel.appendChild(o);
        });
      }

      window._rowsLoaded = true;
    }

    // Koppla knappen och ladda initialt
    document.getElementById('refreshBtn').addEventListener('click', () => loadRows(true));

    document.addEventListener('DOMContentLoaded', () => {
      loadRows();
    });
  </script>
</body>
</html>
