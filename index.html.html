<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory — dropdown fix</title>
  <style>
    body { font-family: Inter, Arial, Helvetica, sans-serif; padding:20px; background:#f6f7f9; color:#222 }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:720px }
    label { display:block; margin-bottom:8px; font-weight:600 }
    select { width:100%; padding:8px 12px; border-radius:6px; border:1px solid #d8dce0 }
    button { margin-top:12px; padding:8px 12px; border-radius:6px; border:none; cursor:pointer }
    .muted { color:#6b7280; font-size:13px; margin-top:8px }
    pre { background:#111; color:#fff; padding:8px; border-radius:6px; overflow:auto; max-height:120px }
    .hint { font-size:13px; color:#374151; margin-top:10px }
  </style>
</head>
<body>
  <div class="card">
    <h3>Inventory — dropdown</h3>
    <label for="rowSelect">Select row</label>
    <select id="rowSelect">
      <option value="">Laddar...</option>
    </select>

    <div>
      <button id="refreshBtn">Hämta igen (force)</button>
      <button id="clearBtn" style="margin-left:8px;">Rensa och kör om</button>
    </div>

    <p class="muted">Öppna webbläsarens Console (F12) för loggar. Kolla efter "Fetched rows" och "uniqueCount".</p>

    <div class="hint">OBS: Denna fil ligger i klienten och använder din <strong>anon</strong>-nyckel. För produktion: använd server-side eller begränsa rights.</div>
  </div>

  <script type="module">
    // --- KONFIGURATION (Ändra TABLE_NAME om din tabell heter något annat) ---
    const SUPABASE_URL = 'https://xlgjmznrifbshgcrzjyi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';
    const TABLE_NAME = 'rows_table'; // <-- byt namn om du använder annat

    // --- Importera klient (CDN) ---
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Enkel guard så dropdown inte fylls flera gånger ---
    window._rowsLoaded = false;

    // Ladda och rendera rader
    async function loadRows(force = false) {
      if (window._rowsLoaded && !force) {
        console.log('loadRows: redan inläst — använd refresh för att tvinga om');
        return;
      }

      console.trace('loadRows called');

      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('id, row_name')
        .order('row_name', { ascending: true });

      if (error) {
        console.error('Supabase error', error);
        const sel = document.getElementById('rowSelect');
        sel.innerHTML = '<option value="">Fel vid hämtning</option>';
        return;
      }

      console.log('Fetched rows', data);
      console.table(data.map(d => ({ id: d.id, name: d.row_name })));

      // Dedupe klient-side på row_name
      const uniqueMap = new Map();
      for (const item of data) {
        if (!uniqueMap.has(item.row_name)) uniqueMap.set(item.row_name, item);
      }
      const unique = [...uniqueMap.values()];

      console.log('uniqueCount:', unique.length, 'rawCount:', data.length);
      if (unique.length !== data.length) console.warn('Dubbletter hittades i svaret och togs bort (client-side)');

      // Rendera dropdown
      const sel = document.getElementById('rowSelect');
      sel.innerHTML = '';
      if (unique.length === 0) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'Inga rader';
        sel.appendChild(o);
      } else {
        unique.forEach(r => {
          const o = document.createElement('option');
          o.value = r.id;
          o.textContent = r.row_name;
          sel.appendChild(o);
        });
      }

      window._rowsLoaded = true;
    }

    // Buttons
    document.getElementById('refreshBtn').addEventListener('click', () => loadRows(true));
    document.getElementById('clearBtn').addEventListener('click', () => {
      window._rowsLoaded = false;
      document.getElementById('rowSelect').innerHTML = '<option value="">Laddar...</option>';
      loadRows(true);
    });

    // Kör när sidan är redo
    document.addEventListener('DOMContentLoaded', () => {
      loadRows();
    });
  </script>
</body>
</html>
