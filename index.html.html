<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shared inventory — Stegra</title>
  <style>
    :root{
      --bg-grad: radial-gradient(1100px 520px at 8% -10%, #e9fbf8 0%, transparent 60%),
                 radial-gradient(900px 520px at 110% -20%, #e8f0ff 0%, transparent 60%),
                 #f7faf9;
      --card:#ffffff; --muted:#667272; --text:#0e1f1e;
      --border:#e5eeec; --border-strong:#d9e6e3;
      --primary:#0f8f83; --primary-600:#0c6f67; --primary-weak:#e8f2f1;
      --danger:#b02a2a; --ok:#107a65; --ok-bg:#e9fbf6;
      --warn:#b0720a; --warn-bg:#fff6e0;
      --radius:16px; --shadow:0 12px 36px rgba(16,24,40,.08), 0 1px 8px rgba(16,24,40,.06);
      --shadow-sm:0 6px 18px rgba(16,24,40,.06), 0 1px 4px rgba(16,24,40,.05);
      --stripe:#fbfdfc;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg-grad);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;box-sizing:border-box}
    *,*:before,*:after{box-sizing:inherit}
    .wrap{max-width:1120px;margin:40px auto;padding:0 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:28px 26px}

    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center}
    .logo-wrap{display:flex;align-items:center;justify-content:center;width:60px;height:60px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));border:1px solid var(--border);box-shadow:var(--shadow-sm);backdrop-filter:blur(6px);overflow:hidden}
    .logo{max-width:100%;max-height:100%;object-fit:contain;transform:translateY(1px)}
    h1{margin:0;font-size:38px;font-weight:800;letter-spacing:.2px;line-height:1.1}
    p.sub{margin:6px 0 0;color:var(--muted)}

    label{display:block;font-weight:700;margin:14px 0 8px}
    input[type="text"],input[type="password"],input[type="date"],input[type="number"],select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit;transition:border-color .15s,box-shadow .15s}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgb(15 143 131 / 12%)}

    .rowgrid{display:grid;gap:14px;grid-template-columns:minmax(200px,1fr) minmax(170px,1fr) 120px 140px 170px}
    @media (max-width:1080px){.rowgrid{grid-template-columns:1fr 1fr 1fr}}
    @media (max-width:720px){.rowgrid{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.rowgrid{grid-template-columns:1fr}}

    .serial-inline{display:flex;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 16px;border:0;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .06s,box-shadow .15s,background .15s}
    .btn svg{width:18px;height:18px}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:var(--shadow-sm)}
    .btn.primary:hover{background:var(--primary-600);transform:translateY(-1px)}
    .btn.secondary{background:var(--primary-weak);color:var(--primary)}
    .btn.secondary:hover{filter:brightness(.96)}
    .btn.link{background:transparent;border:1px solid var(--border);color:#0a5e56}
    .btn.link:hover{background:#f2fbfa}
    .btn.danger{background:#f6e8e8;color:#b02a2a}
    .btn.danger:hover{filter:brightness(.98)}
    .btn.tiny{padding:6px 10px;font-weight:600}

    .actions-top{display:flex;justify-content:space-between;gap:12px;margin-top:12px}
    .actions-row{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .right{margin-left:auto}
    @media (max-width:640px){
      .actions-top{flex-direction:column}
      .actions-top .btn{width:100%;justify-content:center}
      .actions-row .btn{flex:1 1 180px}
      .right{margin-left:0}
    }

    .cap-line{display:flex;align-items:center;gap:10px;margin-top:8px}
    .cap-chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px;background:#fff}
    .cap-chip.ok{color:var(--ok);background:var(--ok-bg);border-color:#c6efe6}
    .cap-chip.warn{color:var(--warn);background:var(--warn-bg);border-color:#f6e6bf}
    .cap-chip.danger{color:var(--danger);background:#fdecec;border-color:#f5cccc}

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:1080px}
    thead th{position:sticky;top:0;background:#fbfffe;border-bottom:1px solid var(--border-strong);padding:12px 12px;text-align:left;font-size:13px;color:#3b4746}
    tbody td{padding:14px 12px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--stripe)}
    tbody tr:hover{background:#f3fbf9}
    @media (max-width:740px){.col-added-at{display:none}}
    @media (max-width:620px){.col-added-date{display:none}}

    .amount-cell{display:flex;align-items:center;gap:10px}
    .qty-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
    .qty-btn:hover{border-color:#cfe4e0;background:#f6fcfb}
    .qty-btn[disabled]{opacity:.45;cursor:not-allowed}
    .qty-value{min-width:24px;text-align:center;font-weight:800}

    .space-wrap{display:flex;align-items:center;gap:8px}
    .space-edit{width:80px;padding:8px 10px;border:1px solid var(--border);border-radius:10px}

    .status{display:inline-flex;align-items:center;gap:8px;margin-top:14px;font-size:13px;color:var(--muted);padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .status.ok{color:#107a65;background:#e9fbf6;border-color:#c6efe6}
    .status.err{color:#b02a2a;background:#fdecec;border-color:#f5cccc}

    /* login */
    .center{min-height:60vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-card{max-width:460px;width:100%}
    .login-title{font-size:28px;font-weight:800;margin:0 0 6px}
    .login-sub{color:var(--muted);margin:0 0 18px}
    .error{color:#b02a2a;background:#fdecec;border:1px solid #f5cccc;border-radius:10px;padding:10px;margin-top:10px;display:none}
    .login-brand{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .login-logo-wrap{display:flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));border:1px solid var(--border);box-shadow:var(--shadow-sm);backdrop-filter:blur(6px);overflow:hidden}
    .login-logo{max-width:100%;max-height:100%;object-fit:contain;transform:translateY(1px)}

    .obj-text,.serial-text{cursor:text;border-radius:6px;padding:2px 4px}
    .obj-text:hover,.serial-text:hover{background:#f2fbfa;border:1px solid var(--border)}
    .obj-edit,.serial-edit{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;font:inherit}
    .obj-edit:focus,.serial-edit:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgb(15 143 131 / 12%)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:24px;z-index:60}
    .modal-backdrop.show{display:flex!important}
    .modal{max-width:980px;width:100%;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:22px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;flex-wrap:wrap}
    .chart-wrap{width:100%;height:520px;border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden}
    @media (max-width:640px){.chart-wrap{height:400px}}
    .legend{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginView" class="wrap center">
    <div class="card login-card">
      <div class="login-brand">
        <div class="login-logo-wrap">
          <img class="login-logo" alt="Stegra Logistics" src="https://api.zeet.se/uploads/companies/RZH4VM4sB/files/exZewH5VpU/stegrish-removebg-preview.png"/>
        </div>
        <div>
          <h2 class="login-title">Stegra Logistics</h2>
          <p class="login-sub">Sign in to access the shared inventory.</p>
        </div>
      </div>

      <label for="loginUser">Username</label>
      <input id="loginUser" type="text" autocomplete="username"/>
      <label for="loginPass">Password</label>
      <input id="loginPass" type="password" placeholder="••••••••••" autocomplete="current-password"/>

      <div class="actions-top">
        <button id="loginBtn" class="btn primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10V7a5 5 0 0 1 10 0v3M6 10h12v9H6z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Sign in</span>
        </button>
        <span></span>
      </div>
      <div id="loginError" class="error">Invalid username or password.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="wrap" style="display:none">
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="logo-wrap">
            <img class="logo" alt="Stegra Logistics" src="https://api.zeet.se/uploads/companies/RZH4VM4sB/files/exZewH5VpU/stegrish-removebg-preview.png"/>
          </div>
          <div>
            <h1>Shared inventory</h1>
            <p class="sub">Everyone who opens this page sees the same list. Changes autosave automatically.</p>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="dashboardBtn" class="btn link" title="Open dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3v18h18M7 15v3m5-8v11m5-14v14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            <span>Dashboard</span>
          </button>
          <button id="logoutBtn" class="btn secondary" title="Sign out">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 12H3m6-6L3 12l6 6M21 3v18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Logout</span>
          </button>
        </div>
      </div>

      <div>
        <label for="rowSelect">Select row</label>
        <div class="cap-line">
          <select id="rowSelect" aria-label="Row"></select>
          <span id="capChip" class="cap-chip">Capacity: –</span>
        </div>
      </div>

      <!-- Inputs -->
      <div class="rowgrid" style="margin-top:12px">
        <div>
          <label for="itemObject">Object</label>
          <input id="itemObject" type="text" placeholder="Object — e.g. Valve ABC-123"/>
        </div>

        <div>
          <label for="itemSerial">Serial</label>
          <div class="serial-inline">
            <input id="itemSerial" type="text" placeholder="Scan or type…"/>
            <button id="scanBtn" class="btn secondary" type="button">Scan</button>
          </div>
        </div>

        <div>
          <label for="itemAmount">Amount</label>
          <input id="itemAmount" type="number" min="1" step="1" value="1"/>
        </div>

        <div>
          <label for="itemSpace">Space % (per unit)</label>
          <input id="itemSpace" type="number" min="1" max="100" step="1" value="10"
                 title="How large space a single unit takes of the row (1–100%)"/>
        </div>

        <div>
          <label for="itemDate">Added date</label>
          <input id="itemDate" type="date"/>
        </div>
      </div>

      <div class="actions-top">
        <button id="addBtn" class="btn primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          <span>Add to list</span>
        </button>
        <span></span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:44px;"><input type="checkbox" id="checkAll" title="Select all"/></th>
              <th>Object</th>
              <th>Serial</th>
              <th style="width:190px;">Amount</th>
              <th style="width:180px;">Space % (per unit)</th>
              <th class="col-added-date" style="width:170px;">Added date</th>
              <th class="col-added-at" style="width:230px;">Added at</th>
              <th style="width:120px;">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="actions-row">
        <button id="removeSelectedBtn" class="btn danger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          <span>Remove selected</span>
        </button>
        <div class="right">
          <button id="exportCsvBtn" class="btn secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3v10m0 0l-3-3m3 3l3-3M5 21h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Export CSV</span>
          </button>
        </div>
      </div>

      <div id="status" class="status">Status: ready</div>
    </div>
  </div>

  <!-- DASHBOARD MODAL -->
  <div id="dashBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dashTitle">
      <div class="modal-header">
        <h2 id="dashTitle">Inventory dashboard</h2>
        <div class="seg" role="tablist" aria-label="Dashboard mode">
          <button id="modeCapacity" class="active" aria-selected="true">Capacity</button>
          <button id="modeAmount">Amount</button>
        </div>
        <button id="dashClose" class="btn secondary">Close</button>
      </div>
      <p class="legend" id="dashSummary">Loading…</p>
      <div class="chart-wrap"><canvas id="dashCanvas"></canvas></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="dashRefresh" class="btn link">Refresh</button>
        <button id="dashDownload" class="btn link">Download PNG</button>
      </div>
    </div>
  </div>

  <!-- SCAN MODAL (camera) -->
  <div id="scanModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" style="max-width:560px">
      <div class="modal-header">
        <h3 style="margin:0">Scan serial</h3>
        <button id="scanClose" class="btn secondary">Close</button>
      </div>
      <video id="scanVideo" playsinline style="width:100%;border-radius:10px;background:#000;min-height:260px"></video>
      <p class="legend">Point the camera at the barcode/QR. It will auto-fill and close.</p>
    </div>
  </div>

  <!-- ZXing fallback (only loads once, safe) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){ /* ===== IIFE: isolates everything ===== */

    /* AUTH */
    const FIXED_USER = 'stegra-logistics';
    const FIXED_PASS_SHA256 = 'b2320acb7841b387c0ad4c23bb5c41d559fe8d1192816f2c54fad279e8a8a3e6'; // "Stegra123"

    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');
    const loginBtn  = document.getElementById('loginBtn');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginErr  = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');

    function setAuthedUI(isAuthed){ loginView.style.display = isAuthed ? 'none' : ''; appView.style.display = isAuthed ? '' : 'none'; }
    async function sha256Hex(str){ const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function doLogin(){
      loginErr.style.display='none';
      const u=(loginUser.value||'').trim().toLowerCase();
      const pHash=await sha256Hex(loginPass.value||'');
      if(u===FIXED_USER && pHash===FIXED_PASS_SHA256){
        localStorage.setItem('inv_auth',JSON.stringify({u,t:Date.now()}));
        requestAnimationFrame(()=>{ setAuthedUI(true); startApp(); });
      }else loginErr.style.display='block';
    }
    function doLogout(){ localStorage.removeItem('inv_auth'); setAuthedUI(false); loginUser.value=''; loginPass.value=''; teardownApp(); }
    loginBtn.addEventListener('click',doLogin);
    loginPass.addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();doLogin();}});
    logoutBtn.addEventListener('click',doLogout);
    window.addEventListener('DOMContentLoaded',()=>{ try{ const s=JSON.parse(localStorage.getItem('inv_auth')||'{}'); if(s.u===FIXED_USER){ setAuthedUI(true); startApp(); return;} }catch{} setAuthedUI(false); });

    /* APP */
    const SUPABASE_URL='https://xlgjmznrifbshgcrzjyi.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2ptem5yaWZic2hnY3J6anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NzE1MDYsImV4cCI6MjA3NjA0NzUwNn0.azm1He9moLcyAeXVlyd4SLnms-AL_2ET5_41-kviugY';
    const TABLE='inventory_items';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    const rowsList=Array.from({length:20},(_,i)=>`ROW${i+1}`);
    let currentRow=localStorage.getItem('inv_row')||'ROW1';
    let currentItems=[]; let wired=false; let dashMode='capacity';

    // DOM
    const rowSelect=document.getElementById('rowSelect');
    const capChip=document.getElementById('capChip');
    const itemObject=document.getElementById('itemObject');
    const itemSerial=document.getElementById('itemSerial');
    const itemAmount=document.getElementById('itemAmount');
    const itemDate=document.getElementById('itemDate');
    const itemSpace=document.getElementById('itemSpace');
    const addBtn=document.getElementById('addBtn');
    const itemsBody=document.getElementById('itemsBody');
    const checkAll=document.getElementById('checkAll');
    const removeBtn=document.getElementById('removeSelectedBtn');
    const exportBtn=document.getElementById('exportCsvBtn');
    const statusEl=document.getElementById('status');

    const dashBackdrop=document.getElementById('dashBackdrop');
    const dashClose=document.getElementById('dashClose');
    const dashRefresh=document.getElementById('dashRefresh');
    const dashDownload=document.getElementById('dashDownload');
    const dashSummary=document.getElementById('dashSummary');
    const dashCanvas=document.getElementById('dashCanvas');
    const modeCapacityBtn=document.getElementById('modeCapacity');
    const modeAmountBtn=document.getElementById('modeAmount');
    const dashboardBtn=document.getElementById('dashboardBtn');

    // Scan modal DOM
    const scanBtn=document.getElementById('scanBtn');
    const scanModal=document.getElementById('scanModal');
    const scanVideo=document.getElementById('scanVideo');
    const scanClose=document.getElementById('scanClose');

    const setStatus=(s,type='neutral')=>{ statusEl.textContent=`Status: ${s}`; statusEl.classList.remove('ok','err'); if(type==='ok') statusEl.classList.add('ok'); if(type==='err') statusEl.classList.add('err'); };
    const todayStr=()=>new Date().toISOString().slice(0,10);

    function capacityOfRow(items){
      return items.reduce((sum,it)=>{
        const per=Number(it.space_pct||0), amt=Number(it.amount||0);
        if(Number.isFinite(per)&&Number.isFinite(amt)) return sum + per*amt;
        return sum;
      },0);
    }
    function renderCapacityChip(){
      const cap=Math.round(capacityOfRow(currentItems));
      capChip.textContent = `Capacity: ${cap}%`;
      capChip.classList.remove('ok','warn','danger');
      if(cap>100) capChip.classList.add('danger');
      else if(cap>=90) capChip.classList.add('warn');
      else capChip.classList.add('ok');
      capChip.title = cap>100 ? 'Over 100% — row is overfilled' : 'Sum of (amount × per-unit space %)';
    }

    function renderItems(){
      itemsBody.innerHTML='';
      currentItems.forEach(it=>{
        const tr=document.createElement('tr');

        const tdC=document.createElement('td');
        const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.id=it.id; tdC.appendChild(cb);

        const tdObj=document.createElement('td');
        const span=document.createElement('span'); span.className='obj-text'; span.dataset.id=it.id; span.textContent=it.object||''; tdObj.appendChild(span);

        const tdSerial=document.createElement('td');
        const sspan=document.createElement('span'); sspan.className='serial-text'; sspan.dataset.id=it.id; sspan.textContent=it.serial||''; tdSerial.appendChild(sspan);

        const tdAmt=document.createElement('td'); tdAmt.className='amount-cell';
        const dec=document.createElement('button'); dec.className='qty-btn'; dec.dataset.action='dec'; dec.dataset.id=it.id; dec.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>';
        const val=document.createElement('span'); val.className='qty-value'; val.dataset.valId=it.id; val.textContent=Number(it.amount||0);
        const inc=document.createElement('button'); inc.className='qty-btn'; inc.dataset.action='inc'; inc.dataset.id=it.id; inc.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>';
        tdAmt.append(dec,val,inc);

        const tdSpace=document.createElement('td');
        const sw=document.createElement('div'); sw.className='space-wrap';
        const inp=document.createElement('input'); inp.type='number'; inp.min='1'; inp.max='100'; inp.step='1';
        inp.value = Number(it.space_pct||0) || '';
        inp.className='space-edit'; inp.dataset.id=it.id; inp.title='Per-unit space %';
        const total = Number(it.amount||0) * (Number(it.space_pct||0) || 0);
        const hint=document.createElement('span'); hint.style.color='#667272'; hint.style.fontSize='12px'; hint.textContent = total? `= ${total}%` : '';
        sw.append(inp,hint); tdSpace.appendChild(sw);

        const tdDate=document.createElement('td'); tdDate.className='col-added-date'; tdDate.textContent=it.added_date||'';
        const tdAt=document.createElement('td'); tdAt.className='col-added-at'; tdAt.textContent=it.added_at?new Date(it.added_at).toLocaleString():'';

        const tdAct=document.createElement('td');
        const mBtn=document.createElement('button'); mBtn.className='btn tiny link'; mBtn.textContent='Move'; mBtn.dataset.id=it.id;
        mBtn.title='Move this item to another row';
        tdAct.appendChild(mBtn);

        tr.append(tdC,tdObj,tdSerial,tdAmt,tdSpace,tdDate,tdAt,tdAct);
        itemsBody.appendChild(tr);
        dec.disabled=Number(it.amount||0)<=1;
      });
      renderCapacityChip();
    }

    async function loadForRow(row){
      try{
        setStatus(`loading ${row}...`);
        const {data,error}=await supabase.from(TABLE)
          .select('id,row,object,serial,amount,space_pct,added_date,added_at')
          .eq('row',row).order('added_at',{ascending:true});
        if(error) throw error;
        currentItems=Array.isArray(data)?data:[];
        renderItems();
        setStatus('ready','ok');
      }catch(err){ console.error('loadForRow error',err); setStatus(`error loading: ${err.message}`,'err'); }
    }

    async function addItem(){
      const obj=(itemObject.value||'').trim();
      if(!obj){ alert('Enter an object name'); return; }
      const serialVal=(itemSerial.value||'').trim() || null;
      const dateVal=itemDate.value||todayStr();
      const amountVal=Math.max(1,Number(itemAmount.value)||1);
      let spaceVal=Number(itemSpace.value); if(!Number.isFinite(spaceVal)||spaceVal<1) spaceVal=1; if(spaceVal>100) spaceVal=100;

      const newItem={ id:(crypto?.randomUUID?.()||String(Date.now())), row:currentRow, object:obj, serial:serialVal, amount:amountVal, space_pct:spaceVal, added_date:dateVal, added_at:new Date().toISOString() };

      try{
        setStatus('saving...');
        const {data,error}=await supabase.from(TABLE).insert(newItem).select().maybeSingle();
        if(error){
          if(error.message && /duplicate key value/i.test(error.message)) throw new Error('Serial already exists');
          throw error;
        }
        if(currentRow===newItem.row){ currentItems.push(data||newItem); renderItems(); }
        itemObject.value=''; itemSerial.value=''; itemAmount.value=1; itemSpace.value=10;
        setStatus('saved','ok');
      }catch(err){
        console.error('insert error',err);
        setStatus(`save failed: ${err.message}`,'err');
        if(/Serial already exists/i.test(err.message)) alert('Serial already exists on another item.');
      }
    }

    async function updateAmount(id,delta){
      const idx=currentItems.findIndex(x=>String(x.id)===String(id));
      if(idx===-1) return;
      const newVal=Math.max(1,Number(currentItems[idx].amount||0)+delta);
      currentItems[idx].amount=newVal; renderItems();
      try{
        setStatus('updating amount...');
        const {error}=await supabase.from(TABLE).update({amount:newVal}).eq('id',id).eq('row',currentRow);
        if(error) throw error;
        setStatus('updated','ok');
      }catch(err){
        currentItems[idx].amount=Math.max(1,newVal-delta); renderItems();
        setStatus(`update failed: ${err.message}`,'err');
      }
    }

    async function updateSpace(id,newVal){
      const idx=currentItems.findIndex(x=>String(x.id)===String(id));
      if(idx===-1) return;
      const old=currentItems[idx].space_pct||0;
      currentItems[idx].space_pct=newVal; renderItems();
      try{
        setStatus('updating space...');
        const {error}=await supabase.from(TABLE).update({space_pct:newVal}).eq('id',id).eq('row',currentRow);
        if(error) throw error;
        setStatus('updated','ok');
      }catch(err){
        currentItems[idx].space_pct=old; renderItems();
        setStatus(`update failed: ${err.message}`,'err');
      }
    }

    async function renameObject(id,newName,revert){
      const idx=currentItems.findIndex(x=>String(x.id)===String(id));
      if(idx===-1) return;
      const old=currentItems[idx].object||'';
      const name=(newName||'').trim();
      if(name===''||name===old){ revert(old); return; }
      currentItems[idx].object=name; renderItems();
      try{
        setStatus('renaming...');
        const {error}=await supabase.from(TABLE).update({object:name}).eq('id',id).eq('row',currentRow);
        if(error) throw error;
        setStatus('updated','ok');
      }catch(err){
        currentItems[idx].object=old; renderItems();
        setStatus(`rename failed: ${err.message}`,'err');
      }
    }

    async function renameSerial(id,newSerial,revert){
      const idx=currentItems.findIndex(x=>String(x.id)===String(id));
      if(idx===-1) return;
      const old=currentItems[idx].serial||'';
      const val=(newSerial||'').trim() || null;
      if((val||'')===old){ revert(old); return; }
      currentItems[idx].serial=val; renderItems();
      try{
        setStatus('updating serial...');
        const {error}=await supabase.from(TABLE).update({serial:val}).eq('id',id).eq('row',currentRow);
        if(error){
          if(error.message && /duplicate key value/i.test(error.message)) throw new Error('Serial already exists');
          throw error;
        }
        setStatus('updated','ok');
      }catch(err){
        currentItems[idx].serial=old; renderItems();
        setStatus(`serial failed: ${err.message}`,'err');
        if(/Serial already exists/i.test(err.message)) alert('Serial already exists on another item.');
      }
    }

    async function moveItem(id,targetRow){
      const idx=currentItems.findIndex(x=>String(x.id)===String(id));
      if(idx===-1) return;
      try{
        setStatus(`moving to ${targetRow}...`);
        const {error}=await supabase.from(TABLE).update({row:targetRow}).eq('id',id).eq('row',currentRow);
        if(error) throw error;
        currentItems.splice(idx,1);
        renderItems();
        setStatus('moved','ok');
      }catch(err){ console.error('move error',err); setStatus(`move failed: ${err.message}`,'err'); }
    }

    async function removeSelected(){
      const checks=[...itemsBody.querySelectorAll('input[type=checkbox]:checked')];
      const ids=checks.map(c=>c.dataset.id);
      if(ids.length===0){ alert('No items selected'); return; }
      try{
        setStatus('removing...');
        const {error}=await supabase.from(TABLE).delete().in('id',ids).eq('row',currentRow);
        if(error) throw error;
        currentItems=currentItems.filter(it=>!ids.includes(String(it.id)));
        renderItems(); checkAll.checked=false;
        setStatus('removed','ok');
      }catch(err){ console.error('remove error',err); setStatus(`remove failed: ${err.message}`,'err'); }
    }

    function exportCSV(items){
      if(!Array.isArray(items)||items.length===0){ alert('Nothing to export'); return; }
      const headers=['row','object','serial','amount','space_pct','added_date','added_at'];
      const rows=items.map(it=>[it.row??'',it.object??'',it.serial??'',it.amount??0,(it.space_pct??''),it.added_date??'',it.added_at??'']);
      const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
      const csv=[headers.join(','),...rows.map(r=>r.map(esc).join(','))].join('\r\n');
      const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      const d=new Date(); a.href=url; a.download=`inventory-${currentRow}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ========== Events (UI) ========== */
    function wireEventsOnce(){
      if(wired) return; wired=true;

      addBtn.addEventListener('click',addItem);
      removeBtn.addEventListener('click',removeSelected);
      exportBtn.addEventListener('click',()=>exportCSV(currentItems));
      checkAll.addEventListener('change',e=>{
        itemsBody.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=e.target.checked);
      });

      rowSelect.addEventListener('change',async e=>{
        currentRow=e.target.value; localStorage.setItem('inv_row',currentRow);
        checkAll.checked=false; await loadForRow(currentRow);
      });

      // inline handlers: amount, object, serial, space, move
      itemsBody.addEventListener('click',e=>{
        const btn=e.target.closest('.qty-btn'); if(btn){ updateAmount(btn.dataset.id, btn.dataset.action==='inc'?+1:-1); return; }

        const span=e.target.closest('.obj-text'); if(span){
          const id=span.dataset.id, old=span.textContent;
          const inp=document.createElement('input'); inp.type='text'; inp.value=old; inp.className='obj-edit';
          span.replaceWith(inp); inp.focus(); inp.select();
          const revert=(txt)=>{ const s=document.createElement('span'); s.className='obj-text'; s.dataset.id=id; s.textContent=txt; inp.replaceWith(s); };
          const save =()=>renameObject(id,inp.value,revert);
          const cancel=()=>revert(old);
          inp.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ev.preventDefault();save();} else if(ev.key==='Escape'){ev.preventDefault();cancel();} });
          inp.addEventListener('blur',save);
          return;
        }

        const sspan=e.target.closest('.serial-text'); if(sspan){
          const id=sspan.dataset.id, old=sspan.textContent;
          const inp=document.createElement('input'); inp.type='text'; inp.value=old; inp.className='serial-edit';
          sspan.replaceWith(inp); inp.focus(); inp.select();
          const revert=(txt)=>{ const s=document.createElement('span'); s.className='serial-text'; s.dataset.id=id; s.textContent=txt; inp.replaceWith(s); };
          const save =()=>renameSerial(id,inp.value,revert);
          const cancel=()=>revert(old);
          inp.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ev.preventDefault();save();} else if(ev.key==='Escape'){ev.preventDefault();cancel();} });
          inp.addEventListener('blur',save);
          return;
        }

        const moveBtn=e.target.closest('.btn.tiny.link');
        if(moveBtn){
          const id=moveBtn.dataset.id;
          const sel=document.createElement('select'); sel.className='space-edit';
          rowsList.forEach(r=>{
            const opt=document.createElement('option'); opt.value=r; opt.textContent=r; if(r===currentRow) opt.disabled=true; sel.appendChild(opt);
          });
          moveBtn.replaceWith(sel); sel.focus();
          sel.addEventListener('change',()=>{ moveItem(id, sel.value); });
          sel.addEventListener('blur',()=>{ if(sel.parentElement){ const back=document.createElement('button'); back.className='btn tiny link'; back.textContent='Move'; back.dataset.id=id; sel.replaceWith(back);} });
        }
      });

      itemsBody.addEventListener('change',e=>{
        const spaceInput=e.target.closest('.space-edit');
        if(spaceInput && spaceInput.dataset.id){
          let v=Number(spaceInput.value);
          if(!Number.isFinite(v)) return;
          v=Math.max(1,Math.min(100,Math.round(v)));
          spaceInput.value=v;
          updateSpace(spaceInput.dataset.id,v);
        }
      });

      // Dashboard
      dashboardBtn.addEventListener('click', async ()=>{ openDashboard(); await loadDashboard(); });
      dashClose.addEventListener('click',closeDashboard);
      dashRefresh.addEventListener('click',loadDashboard);
      dashDownload.addEventListener('click',downloadChart);
      dashBackdrop.addEventListener('click',e=>{ if(e.target===dashBackdrop) closeDashboard(); });

      modeCapacityBtn.addEventListener('click',()=>{ dashMode='capacity'; modeCapacityBtn.classList.add('active'); modeCapacityBtn.setAttribute('aria-selected','true'); modeAmountBtn.classList.remove('active'); modeAmountBtn.removeAttribute('aria-selected'); loadDashboard(); });
      modeAmountBtn.addEventListener('click',()=>{ dashMode='amount';   modeAmountBtn.classList.add('active');   modeAmountBtn.setAttribute('aria-selected','true'); modeCapacityBtn.classList.remove('active'); modeCapacityBtn.removeAttribute('aria-selected'); loadDashboard(); });
    }

    /* ===== Dashboard drawing ===== */
    let dashData=[], _resize=null;
    function openDashboard(){ dashBackdrop.classList.add('show'); }
    function closeDashboard(){ dashBackdrop.classList.remove('show'); if(_resize){window.removeEventListener('resize',_resize); _resize=null;} }

    async function loadDashboard(){
      try{
        setStatus('loading dashboard...');
        const fields = dashMode==='capacity' ? 'row,amount,space_pct' : 'row,amount';
        const {data,error}=await supabase.from(TABLE).select(fields);
        if(error) throw error;

        const agg={}; for(const r of rowsList) agg[r]=0;
        for(const it of (data||[])){
          const r=it.row||'UNKNOWN'; if(!(r in agg)) agg[r]=0;
          if(dashMode==='capacity'){
            const perUnit = Number(it.space_pct||0);
            const amt     = Number(it.amount||0);
            const add     = (Number.isFinite(perUnit)&&Number.isFinite(amt)) ? perUnit*amt : 0;
            agg[r]+=add;
          }else{
            agg[r]+=Number(it.amount||0);
          }
        }
        dashData=Object.entries(agg).map(([row,value])=>({row,value})).sort((a,b)=>b.value-a.value);

        if(dashMode==='capacity'){
          const over=dashData.filter(x=>x.value>100).length;
          const avg =(dashData.reduce((s,x)=>s+Math.min(100,x.value),0)/dashData.length)||0;
          dashSummary.textContent=`Mode: Capacity • Avg fill: ${avg.toFixed(0)}% • Overflow rows: ${over}`;
        }else{
          const total=dashData.reduce((s,x)=>s+x.value,0);
          dashSummary.textContent=`Mode: Amount • Total amount across rows: ${total}`;
        }

        drawBar(); if(!_resize){ _resize=()=>drawBar(); window.addEventListener('resize',_resize); }
        setStatus('dashboard ready','ok');
      }catch(err){ console.error('dash error',err); setStatus(`dashboard error: ${err.message}`,'err'); }
    }

    function drawBar(){
      const cvs=dashCanvas, ctx=cvs.getContext('2d'), parent=cvs.parentElement, dpr=Math.max(1,window.devicePixelRatio||1);
      const padL=110,padR=24,padT=24,padB=24,gap=10,barH=22;
      const n=dashData.length, needH=padT+padB+n*barH+Math.max(0,(n-1))*gap;
      const w=Math.max(300,parent.clientWidth), h=Math.max(260,Math.min(720,needH));
      cvs.style.width=w+'px'; cvs.style.height=h+'px'; cvs.width=Math.floor(w*dpr); cvs.height=Math.floor(h*dpr);
      ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,w,h); ctx.font='13px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif';

      const values=dashData.map(x=>x.value);
      const maxRef=(dashMode==='capacity')?100:Math.max(1,...values);
      const chartW=w-padL-padR;

      ctx.strokeStyle='#e5eeec'; ctx.beginPath(); ctx.moveTo(padL,padT-6); ctx.lineTo(padL,h-padB); ctx.stroke();

      dashData.forEach((d,i)=>{
        const y=padT+i*(barH+gap);
        ctx.fillStyle='#3b4746'; ctx.textAlign='left'; ctx.fillText(d.row,12,y+barH-6);
        const ref=(dashMode==='capacity')?Math.min(100,d.value):d.value;
        const bw=Math.round((ref/maxRef)*chartW);
        ctx.fillStyle='#0f8f83'; roundRect(ctx,padL,y,bw,barH,6,true,false);
        ctx.fillStyle='#0e1f1e'; const label=(dashMode==='capacity')?`${Math.round(d.value)}%`:String(d.value);
        ctx.fillText(label,padL+bw+6,y+barH-6);
      });

      function roundRect(ctx,x,y,w,h,r,fill,stroke){
        if(w<=0||h<=0) return; if(r>h/2) r=h/2; if(r>w/2) r=w/2;
        ctx.beginPath();
        ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r);
        ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r);
        ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke();
      }
    }
    function downloadChart(){ const a=document.createElement('a'); a.download=`inventory-dashboard-${dashMode}-${new Date().toISOString().slice(0,10)}.png`; a.href=dashCanvas.toDataURL('image/png'); document.body.appendChild(a); a.click(); a.remove(); }

    /* ===== Scanner (BarcodeDetector → ZXing fallback) ===== */
    let _scanStream=null, _zxingReader=null, _scanLoopReq=null;
    function openScan(){ scanModal.classList.add('show'); }
    function closeScan(){
      scanModal.classList.remove('show');
      if(_scanLoopReq){ cancelAnimationFrame(_scanLoopReq); _scanLoopReq=null; }
      if(_scanStream){ _scanStream.getTracks().forEach(t=>t.stop()); _scanStream=null; }
      if(_zxingReader){ try{ _zxingReader.reset(); }catch{} _zxingReader=null; }
    }
    async function startNativeDetector(){
      const detector=new window.BarcodeDetector({formats:['qr_code','code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf']});
      _scanStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      scanVideo.srcObject=_scanStream; await scanVideo.play();
      const detect=async()=>{
        try{
          const codes=await detector.detect(scanVideo);
          if(codes && codes.length){
            itemSerial.value=(codes[0].rawValue||'').trim();
            closeScan(); return;
          }
        }catch(e){}
        _scanLoopReq=requestAnimationFrame(detect);
      };
      detect();
    }
    async function startZXing(){
      _zxingReader=new ZXing.BrowserMultiFormatReader();
      const devices=await ZXing.BrowserCodeReader.listVideoInputDevices();
      const back=devices.find(d=>/back|environment/i.test(d.label))||devices[0];
      _zxingReader.decodeFromVideoDevice(back?.deviceId, scanVideo, (res,err)=>{
        if(res && res.getText()){
          itemSerial.value=res.getText().trim();
          closeScan();
        }
      });
    }
    scanBtn?.addEventListener('click', async ()=>{
      try{
        openScan();
        if('BarcodeDetector' in window){ await startNativeDetector(); }
        else{ await startZXing(); }
      }catch(err){
        closeScan();
        alert('Could not start camera: '+err.message);
      }
    });
    scanClose?.addEventListener('click', closeScan);
    scanModal.addEventListener('click',e=>{ if(e.target===scanModal) cl
